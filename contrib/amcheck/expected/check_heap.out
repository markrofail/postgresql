CREATE TABLE heaptest (a integer, b text);
-- Check that invalid skip option is rejected
SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'rope');
ERROR:  invalid skip option
HINT:  Valid skip options are "all-visible", "all-frozen", and "none".
-- Check that block range is reject for an empty table
SELECT * FROM verify_heapam(relation := 'heaptest', startblock := 0, endblock := 0);
ERROR:  starting block is out of bounds for relation with no blocks: 0
-- Check that valid options are not rejected nor corruption reported
-- for an empty table
SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'none');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'all-frozen');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'all-visible');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

-- Add some data so subsequent tests are not entirely trivial
INSERT INTO heaptest (a, b)
	(SELECT gs, repeat('x', gs)
		FROM generate_series(1,50) gs);
-- Check that an invalid block range is rejected
SELECT * FROM verify_heapam(relation := 'heaptest', startblock := 100000, endblock := 200000);
ERROR:  block range is out of bounds for relation with block count 1: 100000 .. 200000
-- Check that valid options are not rejected nor corruption reported
-- for a non-empty table
SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'none');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'all-frozen');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'all-visible');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', startblock := 0, endblock := 0);
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

-- Vacuum freeze to change the xids encountered in subsequent tests
VACUUM FREEZE heaptest;
-- Check that valid options are not rejected nor corruption reported
-- for a non-empty frozen table
SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'none');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'all-frozen');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', skip := 'all-visible');
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

SELECT * FROM verify_heapam(relation := 'heaptest', startblock := 0, endblock := 0);
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

-- Check that partitioned tables (the parent ones) which don't have visibility
-- maps are rejected
create table test_partitioned (a int, b text default repeat('x', 5000))
			 partition by list (a);
select * from verify_heapam('test_partitioned',
							startblock := NULL,
							endblock := NULL);
ERROR:  "test_partitioned" is not a table, materialized view, or TOAST table
-- Check that valid options are not rejected nor corruption reported
-- for an empty partition table (the child one)
create table test_partition partition of test_partitioned for values in (1);
select * from verify_heapam('test_partition',
							startblock := NULL,
							endblock := NULL);
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

-- Check that valid options are not rejected nor corruption reported
-- for a non-empty partition table (the child one)
insert into test_partitioned (a) (select 1 from generate_series(1,1000) gs);
select * from verify_heapam('test_partition',
							startblock := NULL,
							endblock := NULL);
 blkno | offnum | attnum | msg 
-------+--------+--------+-----
(0 rows)

-- Check that indexes are rejected
create index test_index on test_partition (a);
select * from verify_heapam('test_index',
							startblock := NULL,
							endblock := NULL);
ERROR:  "test_index" is not a table, materialized view, or TOAST table
-- Check that views are rejected
create view test_view as select 1;
select * from verify_heapam('test_view',
							startblock := NULL,
							endblock := NULL);
ERROR:  "test_view" is not a table, materialized view, or TOAST table
-- Check that sequences are rejected
create sequence test_sequence;
select * from verify_heapam('test_sequence',
							startblock := NULL,
							endblock := NULL);
ERROR:  "test_sequence" is not a table, materialized view, or TOAST table
-- Check that foreign tables are rejected
create foreign data wrapper dummy;
create server dummy_server foreign data wrapper dummy;
create foreign table test_foreign_table () server dummy_server;
select * from verify_heapam('test_foreign_table',
							startblock := NULL,
							endblock := NULL);
ERROR:  "test_foreign_table" is not a table, materialized view, or TOAST table
