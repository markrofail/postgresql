<!-- doc/src/sgml/distributed-transaction.sgml -->

<chapter id="distributed-transaction">
 <title>Distributed Transaction</title>

 <para>
  A distributed transaction is a transaction in which two or more network hosts
  are involved. <productname>PostgreSQL</productname>'s global Transaction
  manager supports distributed transactions that access foreign servers using
  Foreign Data Wrappers. The global transaction manager is responsible for
  managing transactions on foreign servers.
 </para>

 <sect1 id="atomic-commit">
  <title>Atomic Commit</title>

  <para>
   Formerly, transactions on foreign server were simply committed or rolled
   back one by one. Therefore, when one foreign server had a problem during
   commit, it was possible that transactions on only part of foreign servers
   are committed while other transactions are rolled back. This used to leave
   database data in an inconsistent state in term of federated database.
   Atomic commit of distributed transaction is an operation that applies a set
   of changes as a single operation globally. This guarantees all-or-nothing
   results for the changes on all remote hosts involved in.
   <productname>PostgreSQL</productname> provides a way to perform read-write
   transactions with foreign resources using foreign data wrappers.
   Using the <productname>PostgreSQL</productname>'s atomic commit ensures that
   all the changes on foreign servers are either committed or rolled back using
   the transaction callback routines
   (see <xref linkend="fdw-callbacks-transaction-management"/>).
  </para>

  <sect2>
   <title>Atomic Commit Using Two-phase Commit Protocol</title>

   <para>
    To achieve commit among all foreign servers automatically,
    <productname>PostgreSQL</productname> employs two-phase commit protocol,
    which is a type of atomic commitment protocol (ACP).  Using two-phase
    commit protocol, the commit sequence of distributed transaction performs
    with the following steps:
    <orderedlist>
     <listitem>
      <para>
       Prepare all transactions on foreign servers.
       <productname>PostgreSQL</productname>'s distributed transaction manager
       prepares all transaction on the foreign servers if two-phase commit is
       required. Two-phase commit is required when the transaction modifies
       data on two or more servers including the local server itself and
       <xref linkend="guc-foreign-twophase-commit"/> is
       <literal>required</literal>. If the prepare on all foreign servers is
       successful then go to the next step.  If there is any failure in the
       prepare phase, the server will rollback all the transactions on both
       local and foreign servers.
      </para>
     </listitem>
     <listitem>
      <para>
       Commit locally. The server commits transaction locally.  Any failure happens
       in this step the server changes to rollback, then rollback all transactions
       on both local and foreign servers.
      </para>
     </listitem>
     <listitem>
      <para>
       Resolve all prepared transaction on foreign servers. Prepared transactions
       are committed or rolled back according to the result of the local transaction.
       This step is performed by a foreign transaction resolver process.
      </para>
     </listitem>
    </orderedlist>
   </para>

   <para>
    Each commit of a distributed transaction will wait until confirmation is
    received that all prepared transactions are committed or rolled back. The
    guarantee we offeris that the application will not receive explicit
    acknowledgement of the successful commit of a distributed transaction
    until the all foreign transactions are resolved on the foreign servers.
   </para>

   <para>
    When sychronous replication is also used, the distributed transaction
    will wait for synchronous replication first, and then wait for foreign
    transaction resolution.  This is necessary because the fate of local
    transaction commit needs to be consistent among the primary and replicas.
   </para>
  </sect2>

  <sect2 id="atomic-commit-in-doubt-transaction">
   <title>In-Doubt Transactions</title>

   <para>
    The atomic commit mechanism ensures that all foreign servers either commit
    or rollback using two-phase commit protocol. However, foreign transactions
    become <firstterm>in-doubt</firstterm> in two cases:

    <itemizedlist>
     <listitem>
      <para>The local node crashed during either preparing or resolving foreign
       transaction.</para>
     </listitem>
     <listitem>
      <para>user canceled the query.</para>
     </listitem>
    </itemizedlist>

    You can check in-doubt transaction in <xref linkend="view-pg-foreign-xacts"/>
    view. These foreign transactions are resolved by foreign transaction resolver
    process or executing <function>pg_resolve_foriegn_xact</function> function
    manually.
   </para>
  </sect2>

  <sect2 id="atomic-commit-transaction-resolver">
   <title>Foreign Transaction Resolver Processes</title>

   <para>
    Foreign transaction resolver processes are auxiliary processes that are
    responsible for resolving both foreign transactions that are prepared by
    online transactions and in-doubt transactions. They commit or rollback
    prepared transactions on all foreign servers involved with the distributed
    transaction if the local node received agreement messages from all
    foreign servers during the first step of two-phase commit protocol.
   </para>

   <para>
    One foreign transaction resolver is responsible for transaction resolutions
    on the database to which it is connected. On failure during resolution, they
    retry to resolve at an interval of
    <varname>foreign_transaction_resolution_interval</varname> time.
   </para>

   <note>
    <para>
     During a foreign transaction resolver process connecting to the database,
     database cannot be dropped without immediate shutdown. You can call
     <function>pg_stop_foreign_xact_resovler</function> function to stop the
     particular resolver process before dropping the database.
    </para>
   </note>
  </sect2>

  <sect2>
   <title>Configuration Settings</title>

   <para>
    Atomic commit requires several configuration options to be set.
    On the local node, <xref linkend="guc-max-prepared-foreign-transactions"/> and
    <xref linkend="guc-max-foreign-transaction-resolvers"/> must be non-zero value,
    and <xref linkend="guc-foreign-twophase-commit"/> must be enabled.  Additionally
    the <varname>max_worker_processes</varname> may need to be adjusted
    to accommodate for foreign transaction resolver workers, at least
    (<varname>max_foreign_transaction_resolvers</varname> + <literal>1</literal>).
    Note that other <productname>PostgreSQL</productname> features such as parallel
    queries, logical replication, etc., also take worker slots from
    <varname>max_worker_processes</varname>.
   </para>
  </sect2>
 </sect1>
</chapter>
