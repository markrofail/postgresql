--
-- CONSTRAINTS
-- Constraints can be specified with:
--  - DEFAULT clause
--  - CHECK clauses
--  - PRIMARY KEY clauses
--  - UNIQUE clauses
--  - EXCLUDE clauses
--
--
-- DEFAULT syntax
--
CREATE TABLE DEFAULT_TBL (i int DEFAULT 100,
	x text DEFAULT 'vadim', f float8 DEFAULT 123.456);
INSERT INTO DEFAULT_TBL VALUES (1, 'thomas', 57.0613);
INSERT INTO DEFAULT_TBL VALUES (1, 'bruce');
INSERT INTO DEFAULT_TBL (i, f) VALUES (2, 987.654);
INSERT INTO DEFAULT_TBL (x) VALUES ('marc');
INSERT INTO DEFAULT_TBL VALUES (3, null, 1.0);
SELECT '' AS five, * FROM DEFAULT_TBL;
 five |  i  |   x    |    f    
------+-----+--------+---------
      |   1 | thomas | 57.0613
      |   1 | bruce  | 123.456
      |   2 | vadim  | 987.654
      | 100 | marc   | 123.456
      |   3 |        |       1
(5 rows)

CREATE SEQUENCE DEFAULT_SEQ;
CREATE TABLE DEFAULTEXPR_TBL (i1 int DEFAULT 100 + (200-199) * 2,
	i2 int DEFAULT nextval('default_seq'));
INSERT INTO DEFAULTEXPR_TBL VALUES (-1, -2);
INSERT INTO DEFAULTEXPR_TBL (i1) VALUES (-3);
INSERT INTO DEFAULTEXPR_TBL (i2) VALUES (-4);
INSERT INTO DEFAULTEXPR_TBL (i2) VALUES (NULL);
SELECT '' AS four, * FROM DEFAULTEXPR_TBL;
 four | i1  | i2 
------+-----+----
      |  -1 | -2
      |  -3 |  1
      | 102 | -4
      | 102 |   
(4 rows)

-- syntax errors
--  test for extraneous comma
CREATE TABLE error_tbl (i int DEFAULT (100, ));
ERROR:  syntax error at or near ")"
LINE 1: CREATE TABLE error_tbl (i int DEFAULT (100, ));
                                                    ^
--  this will fail because gram.y uses b_expr not a_expr for defaults,
--  to avoid a shift/reduce conflict that arises from NOT NULL being
--  part of the column definition syntax:
CREATE TABLE error_tbl (b1 bool DEFAULT 1 IN (1, 2));
ERROR:  syntax error at or near "IN"
LINE 1: CREATE TABLE error_tbl (b1 bool DEFAULT 1 IN (1, 2));
                                                  ^
--  this should work, however:
CREATE TABLE error_tbl (b1 bool DEFAULT (1 IN (1, 2)));
DROP TABLE error_tbl;
--
-- CHECK syntax
--
CREATE TABLE CHECK_TBL (x int,
	CONSTRAINT CHECK_CON CHECK (x > 3));
INSERT INTO CHECK_TBL VALUES (5);
INSERT INTO CHECK_TBL VALUES (4);
INSERT INTO CHECK_TBL VALUES (3);
ERROR:  new row for relation "check_tbl" violates check constraint "check_con"
DETAIL:  Failing row contains (3).
INSERT INTO CHECK_TBL VALUES (2);
ERROR:  new row for relation "check_tbl" violates check constraint "check_con"
DETAIL:  Failing row contains (2).
INSERT INTO CHECK_TBL VALUES (6);
INSERT INTO CHECK_TBL VALUES (1);
ERROR:  new row for relation "check_tbl" violates check constraint "check_con"
DETAIL:  Failing row contains (1).
SELECT '' AS three, * FROM CHECK_TBL;
 three | x 
-------+---
       | 5
       | 4
       | 6
(3 rows)

CREATE SEQUENCE CHECK_SEQ;
CREATE TABLE CHECK2_TBL (x int, y text, z int,
	CONSTRAINT SEQUENCE_CON
	CHECK (x > 3 and y <> 'check failed' and z < 8));
INSERT INTO CHECK2_TBL VALUES (4, 'check ok', -2);
INSERT INTO CHECK2_TBL VALUES (1, 'x check failed', -2);
ERROR:  new row for relation "check2_tbl" violates check constraint "sequence_con"
DETAIL:  Failing row contains (1, x check failed, -2).
INSERT INTO CHECK2_TBL VALUES (5, 'z check failed', 10);
ERROR:  new row for relation "check2_tbl" violates check constraint "sequence_con"
DETAIL:  Failing row contains (5, z check failed, 10).
INSERT INTO CHECK2_TBL VALUES (0, 'check failed', -2);
ERROR:  new row for relation "check2_tbl" violates check constraint "sequence_con"
DETAIL:  Failing row contains (0, check failed, -2).
INSERT INTO CHECK2_TBL VALUES (6, 'check failed', 11);
ERROR:  new row for relation "check2_tbl" violates check constraint "sequence_con"
DETAIL:  Failing row contains (6, check failed, 11).
INSERT INTO CHECK2_TBL VALUES (7, 'check ok', 7);
SELECT '' AS two, * from CHECK2_TBL;
 two | x |    y     | z  
-----+---+----------+----
     | 4 | check ok | -2
     | 7 | check ok |  7
(2 rows)

--
-- Check constraints on INSERT
--
CREATE SEQUENCE INSERT_SEQ;
CREATE TABLE INSERT_TBL (x INT DEFAULT nextval('insert_seq'),
	y TEXT DEFAULT '-NULL-',
	z INT DEFAULT -1 * currval('insert_seq'),
	CONSTRAINT INSERT_TBL_CON CHECK (x >= 3 AND y <> 'check failed' AND x < 8),
	CHECK (x + z = 0));
INSERT INTO INSERT_TBL(x,z) VALUES (2, -2);
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (2, -NULL-, -2).
SELECT '' AS zero, * FROM INSERT_TBL;
 zero | x | y | z 
------+---+---+---
(0 rows)

SELECT 'one' AS one, nextval('insert_seq');
 one | nextval 
-----+---------
 one |       1
(1 row)

INSERT INTO INSERT_TBL(y) VALUES ('Y');
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (2, Y, -2).
INSERT INTO INSERT_TBL(y) VALUES ('Y');
INSERT INTO INSERT_TBL(x,z) VALUES (1, -2);
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_check"
DETAIL:  Failing row contains (1, -NULL-, -2).
INSERT INTO INSERT_TBL(z,x) VALUES (-7,  7);
INSERT INTO INSERT_TBL VALUES (5, 'check failed', -5);
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (5, check failed, -5).
INSERT INTO INSERT_TBL VALUES (7, '!check failed', -7);
INSERT INTO INSERT_TBL(y) VALUES ('-!NULL-');
SELECT '' AS four, * FROM INSERT_TBL;
 four | x |       y       | z  
------+---+---------------+----
      | 3 | Y             | -3
      | 7 | -NULL-        | -7
      | 7 | !check failed | -7
      | 4 | -!NULL-       | -4
(4 rows)

INSERT INTO INSERT_TBL(y,z) VALUES ('check failed', 4);
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_check"
DETAIL:  Failing row contains (5, check failed, 4).
INSERT INTO INSERT_TBL(x,y) VALUES (5, 'check failed');
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (5, check failed, -5).
INSERT INTO INSERT_TBL(x,y) VALUES (5, '!check failed');
INSERT INTO INSERT_TBL(y) VALUES ('-!NULL-');
SELECT '' AS six, * FROM INSERT_TBL;
 six | x |       y       | z  
-----+---+---------------+----
     | 3 | Y             | -3
     | 7 | -NULL-        | -7
     | 7 | !check failed | -7
     | 4 | -!NULL-       | -4
     | 5 | !check failed | -5
     | 6 | -!NULL-       | -6
(6 rows)

SELECT 'seven' AS one, nextval('insert_seq');
  one  | nextval 
-------+---------
 seven |       7
(1 row)

INSERT INTO INSERT_TBL(y) VALUES ('Y');
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (8, Y, -8).
SELECT 'eight' AS one, currval('insert_seq');
  one  | currval 
-------+---------
 eight |       8
(1 row)

-- According to SQL, it is OK to insert a record that gives rise to NULL
-- constraint-condition results.  Postgres used to reject this, but it
-- was wrong:
INSERT INTO INSERT_TBL VALUES (null, null, null);
SELECT '' AS nine, * FROM INSERT_TBL;
 nine | x |       y       | z  
------+---+---------------+----
      | 3 | Y             | -3
      | 7 | -NULL-        | -7
      | 7 | !check failed | -7
      | 4 | -!NULL-       | -4
      | 5 | !check failed | -5
      | 6 | -!NULL-       | -6
      |   |               |   
(7 rows)

--
-- Check constraints on system columns
--
CREATE TABLE SYS_COL_CHECK_TBL (city text, state text, is_capital bool,
                  altitude int,
                  CHECK (NOT (is_capital AND tableoid::regclass::text = 'sys_col_check_tbl')));
INSERT INTO SYS_COL_CHECK_TBL VALUES ('Seattle', 'Washington', false, 100);
INSERT INTO SYS_COL_CHECK_TBL VALUES ('Olympia', 'Washington', true, 100);
ERROR:  new row for relation "sys_col_check_tbl" violates check constraint "sys_col_check_tbl_check"
DETAIL:  Failing row contains (Olympia, Washington, t, 100).
SELECT *, tableoid::regclass::text FROM SYS_COL_CHECK_TBL;
  city   |   state    | is_capital | altitude |     tableoid      
---------+------------+------------+----------+-------------------
 Seattle | Washington | f          |      100 | sys_col_check_tbl
(1 row)

DROP TABLE SYS_COL_CHECK_TBL;
--
-- Check constraints on system columns other then TableOid should return error
--
CREATE TABLE SYS_COL_CHECK_TBL (city text, state text, is_capital bool,
                  altitude int,
				  CHECK (NOT (is_capital AND ctid::text = 'sys_col_check_tbl')));
ERROR:  system column "ctid" reference in check constraint is invalid
LINE 3:       CHECK (NOT (is_capital AND ctid::text = 'sys_col_check...
                                         ^
--
-- Check inheritance of defaults and constraints
--
CREATE TABLE INSERT_CHILD (cx INT default 42,
	cy INT CHECK (cy > x))
	INHERITS (INSERT_TBL);
INSERT INTO INSERT_CHILD(x,z,cy) VALUES (7,-7,11);
INSERT INTO INSERT_CHILD(x,z,cy) VALUES (7,-7,6);
ERROR:  new row for relation "insert_child" violates check constraint "insert_child_check"
DETAIL:  Failing row contains (7, -NULL-, -7, 42, 6).
INSERT INTO INSERT_CHILD(x,z,cy) VALUES (6,-7,7);
ERROR:  new row for relation "insert_child" violates check constraint "insert_tbl_check"
DETAIL:  Failing row contains (6, -NULL-, -7, 42, 7).
INSERT INTO INSERT_CHILD(x,y,z,cy) VALUES (6,'check failed',-6,7);
ERROR:  new row for relation "insert_child" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (6, check failed, -6, 42, 7).
SELECT * FROM INSERT_CHILD;
 x |   y    | z  | cx | cy 
---+--------+----+----+----
 7 | -NULL- | -7 | 42 | 11
(1 row)

DROP TABLE INSERT_CHILD;
--
-- Check NO INHERIT type of constraints and inheritance
--
CREATE TABLE ATACC1 (TEST INT
	CHECK (TEST > 0) NO INHERIT);
CREATE TABLE ATACC2 (TEST2 INT) INHERITS (ATACC1);
-- check constraint is not there on child
INSERT INTO ATACC2 (TEST) VALUES (-3);
-- check constraint is there on parent
INSERT INTO ATACC1 (TEST) VALUES (-3);
ERROR:  new row for relation "atacc1" violates check constraint "atacc1_test_check"
DETAIL:  Failing row contains (-3).
DROP TABLE ATACC1 CASCADE;
NOTICE:  drop cascades to table atacc2
CREATE TABLE ATACC1 (TEST INT, TEST2 INT
	CHECK (TEST > 0), CHECK (TEST2 > 10) NO INHERIT);
CREATE TABLE ATACC2 () INHERITS (ATACC1);
-- check constraint is there on child
INSERT INTO ATACC2 (TEST) VALUES (-3);
ERROR:  new row for relation "atacc2" violates check constraint "atacc1_test_check"
DETAIL:  Failing row contains (-3, null).
-- check constraint is there on parent
INSERT INTO ATACC1 (TEST) VALUES (-3);
ERROR:  new row for relation "atacc1" violates check constraint "atacc1_test_check"
DETAIL:  Failing row contains (-3, null).
-- check constraint is not there on child
INSERT INTO ATACC2 (TEST2) VALUES (3);
-- check constraint is there on parent
INSERT INTO ATACC1 (TEST2) VALUES (3);
ERROR:  new row for relation "atacc1" violates check constraint "atacc1_test2_check"
DETAIL:  Failing row contains (null, 3).
DROP TABLE ATACC1 CASCADE;
NOTICE:  drop cascades to table atacc2
--
-- Check constraints on INSERT INTO
--
DELETE FROM INSERT_TBL;
ALTER SEQUENCE INSERT_SEQ RESTART WITH 4;
CREATE TEMP TABLE tmp (xd INT, yd TEXT, zd INT);
INSERT INTO tmp VALUES (null, 'Y', null);
INSERT INTO tmp VALUES (5, '!check failed', null);
INSERT INTO tmp VALUES (null, 'try again', null);
INSERT INTO INSERT_TBL(y) select yd from tmp;
SELECT '' AS three, * FROM INSERT_TBL;
 three | x |       y       | z  
-------+---+---------------+----
       | 4 | Y             | -4
       | 5 | !check failed | -5
       | 6 | try again     | -6
(3 rows)

INSERT INTO INSERT_TBL SELECT * FROM tmp WHERE yd = 'try again';
INSERT INTO INSERT_TBL(y,z) SELECT yd, -7 FROM tmp WHERE yd = 'try again';
INSERT INTO INSERT_TBL(y,z) SELECT yd, -8 FROM tmp WHERE yd = 'try again';
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (8, try again, -8).
SELECT '' AS four, * FROM INSERT_TBL;
 four | x |       y       | z  
------+---+---------------+----
      | 4 | Y             | -4
      | 5 | !check failed | -5
      | 6 | try again     | -6
      |   | try again     |   
      | 7 | try again     | -7
(5 rows)

DROP TABLE tmp;
--
-- Check constraints on UPDATE
--
UPDATE INSERT_TBL SET x = NULL WHERE x = 5;
UPDATE INSERT_TBL SET x = 6 WHERE x = 6;
UPDATE INSERT_TBL SET x = -z, z = -x;
UPDATE INSERT_TBL SET x = z, z = x;
ERROR:  new row for relation "insert_tbl" violates check constraint "insert_tbl_con"
DETAIL:  Failing row contains (-4, Y, 4).
SELECT * FROM INSERT_TBL;
 x |       y       | z  
---+---------------+----
 4 | Y             | -4
   | try again     |   
 7 | try again     | -7
 5 | !check failed |   
 6 | try again     | -6
(5 rows)

-- DROP TABLE INSERT_TBL;
--
-- Check constraints on COPY FROM
--
CREATE TABLE COPY_TBL (x INT, y TEXT, z INT,
	CONSTRAINT COPY_CON
	CHECK (x > 3 AND y <> 'check failed' AND x < 7 ));
COPY COPY_TBL FROM '@abs_srcdir@/data/constro.data';
SELECT '' AS two, * FROM COPY_TBL;
 two | x |       y       | z 
-----+---+---------------+---
     | 4 | !check failed | 5
     | 6 | OK            | 4
(2 rows)

COPY COPY_TBL FROM '@abs_srcdir@/data/constrf.data';
ERROR:  new row for relation "copy_tbl" violates check constraint "copy_con"
DETAIL:  Failing row contains (7, check failed, 6).
CONTEXT:  COPY copy_tbl, line 2: "7	check failed	6"
SELECT * FROM COPY_TBL;
 x |       y       | z 
---+---------------+---
 4 | !check failed | 5
 6 | OK            | 4
(2 rows)

--
-- Primary keys
--
CREATE TABLE PRIMARY_TBL (i int PRIMARY KEY, t text);
INSERT INTO PRIMARY_TBL VALUES (1, 'one');
INSERT INTO PRIMARY_TBL VALUES (2, 'two');
INSERT INTO PRIMARY_TBL VALUES (1, 'three');
ERROR:  duplicate key value violates unique constraint "primary_tbl_pkey"
DETAIL:  Key (i)=(1) already exists.
INSERT INTO PRIMARY_TBL VALUES (4, 'three');
INSERT INTO PRIMARY_TBL VALUES (5, 'one');
INSERT INTO PRIMARY_TBL (t) VALUES ('six');
ERROR:  null value in column "i" of relation "primary_tbl" violates not-null constraint
DETAIL:  Failing row contains (null, six).
SELECT '' AS four, * FROM PRIMARY_TBL;
 four | i |   t   
------+---+-------
      | 1 | one
      | 2 | two
      | 4 | three
      | 5 | one
(4 rows)

DROP TABLE PRIMARY_TBL;
CREATE TABLE PRIMARY_TBL (i int, t text,
	PRIMARY KEY(i,t));
INSERT INTO PRIMARY_TBL VALUES (1, 'one');
INSERT INTO PRIMARY_TBL VALUES (2, 'two');
INSERT INTO PRIMARY_TBL VALUES (1, 'three');
INSERT INTO PRIMARY_TBL VALUES (4, 'three');
INSERT INTO PRIMARY_TBL VALUES (5, 'one');
INSERT INTO PRIMARY_TBL (t) VALUES ('six');
ERROR:  null value in column "i" of relation "primary_tbl" violates not-null constraint
DETAIL:  Failing row contains (null, six).
SELECT '' AS three, * FROM PRIMARY_TBL;
 three | i |   t   
-------+---+-------
       | 1 | one
       | 2 | two
       | 1 | three
       | 4 | three
       | 5 | one
(5 rows)

DROP TABLE PRIMARY_TBL;
--
-- Unique keys
--
CREATE TABLE UNIQUE_TBL (i int UNIQUE, t text);
INSERT INTO UNIQUE_TBL VALUES (1, 'one');
INSERT INTO UNIQUE_TBL VALUES (2, 'two');
INSERT INTO UNIQUE_TBL VALUES (1, 'three');
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_key"
DETAIL:  Key (i)=(1) already exists.
INSERT INTO UNIQUE_TBL VALUES (4, 'four');
INSERT INTO UNIQUE_TBL VALUES (5, 'one');
INSERT INTO UNIQUE_TBL (t) VALUES ('six');
INSERT INTO UNIQUE_TBL (t) VALUES ('seven');
INSERT INTO UNIQUE_TBL VALUES (5, 'five-upsert-insert') ON CONFLICT (i) DO UPDATE SET t = 'five-upsert-update';
INSERT INTO UNIQUE_TBL VALUES (6, 'six-upsert-insert') ON CONFLICT (i) DO UPDATE SET t = 'six-upsert-update';
-- should fail
INSERT INTO UNIQUE_TBL VALUES (1, 'a'), (2, 'b'), (2, 'b') ON CONFLICT (i) DO UPDATE SET t = 'fails';
ERROR:  ON CONFLICT DO UPDATE command cannot affect row a second time
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.
SELECT '' AS five, * FROM UNIQUE_TBL;
 five | i |         t          
------+---+--------------------
      | 1 | one
      | 2 | two
      | 4 | four
      |   | six
      |   | seven
      | 5 | five-upsert-update
      | 6 | six-upsert-insert
(7 rows)

DROP TABLE UNIQUE_TBL;
CREATE TABLE UNIQUE_TBL (i int, t text,
	UNIQUE(i,t));
INSERT INTO UNIQUE_TBL VALUES (1, 'one');
INSERT INTO UNIQUE_TBL VALUES (2, 'two');
INSERT INTO UNIQUE_TBL VALUES (1, 'three');
INSERT INTO UNIQUE_TBL VALUES (1, 'one');
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_t_key"
DETAIL:  Key (i, t)=(1, one) already exists.
INSERT INTO UNIQUE_TBL VALUES (5, 'one');
INSERT INTO UNIQUE_TBL (t) VALUES ('six');
SELECT '' AS five, * FROM UNIQUE_TBL;
 five | i |   t   
------+---+-------
      | 1 | one
      | 2 | two
      | 1 | three
      | 5 | one
      |   | six
(5 rows)

DROP TABLE UNIQUE_TBL;
--
-- Deferrable unique constraints
--
CREATE TABLE unique_tbl (i int UNIQUE DEFERRABLE, t text);
INSERT INTO unique_tbl VALUES (0, 'one');
INSERT INTO unique_tbl VALUES (1, 'two');
INSERT INTO unique_tbl VALUES (2, 'tree');
INSERT INTO unique_tbl VALUES (3, 'four');
INSERT INTO unique_tbl VALUES (4, 'five');
BEGIN;
-- default is immediate so this should fail right away
UPDATE unique_tbl SET i = 1 WHERE i = 0;
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_key"
DETAIL:  Key (i)=(1) already exists.
ROLLBACK;
-- check is done at end of statement, so this should succeed
UPDATE unique_tbl SET i = i+1;
SELECT * FROM unique_tbl;
 i |  t   
---+------
 1 | one
 2 | two
 3 | tree
 4 | four
 5 | five
(5 rows)

-- explicitly defer the constraint
BEGIN;
SET CONSTRAINTS unique_tbl_i_key DEFERRED;
INSERT INTO unique_tbl VALUES (3, 'three');
DELETE FROM unique_tbl WHERE t = 'tree'; -- makes constraint valid again
COMMIT; -- should succeed
SELECT * FROM unique_tbl;
 i |   t   
---+-------
 1 | one
 2 | two
 4 | four
 5 | five
 3 | three
(5 rows)

-- try adding an initially deferred constraint
ALTER TABLE unique_tbl DROP CONSTRAINT unique_tbl_i_key;
ALTER TABLE unique_tbl ADD CONSTRAINT unique_tbl_i_key
	UNIQUE (i) DEFERRABLE INITIALLY DEFERRED;
BEGIN;
INSERT INTO unique_tbl VALUES (1, 'five');
INSERT INTO unique_tbl VALUES (5, 'one');
UPDATE unique_tbl SET i = 4 WHERE i = 2;
UPDATE unique_tbl SET i = 2 WHERE i = 4 AND t = 'four';
DELETE FROM unique_tbl WHERE i = 1 AND t = 'one';
DELETE FROM unique_tbl WHERE i = 5 AND t = 'five';
COMMIT;
SELECT * FROM unique_tbl;
 i |   t   
---+-------
 3 | three
 1 | five
 5 | one
 4 | two
 2 | four
(5 rows)

-- should fail at commit-time
BEGIN;
INSERT INTO unique_tbl VALUES (3, 'Three'); -- should succeed for now
COMMIT; -- should fail
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_key"
DETAIL:  Key (i)=(3) already exists.
-- make constraint check immediate
BEGIN;
SET CONSTRAINTS ALL IMMEDIATE;
INSERT INTO unique_tbl VALUES (3, 'Three'); -- should fail
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_key"
DETAIL:  Key (i)=(3) already exists.
COMMIT;
-- forced check when SET CONSTRAINTS is called
BEGIN;
SET CONSTRAINTS ALL DEFERRED;
INSERT INTO unique_tbl VALUES (3, 'Three'); -- should succeed for now
SET CONSTRAINTS ALL IMMEDIATE; -- should fail
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_key"
DETAIL:  Key (i)=(3) already exists.
COMMIT;
-- test deferrable UNIQUE with a partitioned table
CREATE TABLE parted_uniq_tbl (i int UNIQUE DEFERRABLE) partition by range (i);
CREATE TABLE parted_uniq_tbl_1 PARTITION OF parted_uniq_tbl FOR VALUES FROM (0) TO (10);
CREATE TABLE parted_uniq_tbl_2 PARTITION OF parted_uniq_tbl FOR VALUES FROM (20) TO (30);
SELECT conname, conrelid::regclass FROM pg_constraint
  WHERE conname LIKE 'parted_uniq%' ORDER BY conname;
         conname         |     conrelid      
-------------------------+-------------------
 parted_uniq_tbl_1_i_key | parted_uniq_tbl_1
 parted_uniq_tbl_2_i_key | parted_uniq_tbl_2
 parted_uniq_tbl_i_key   | parted_uniq_tbl
(3 rows)

BEGIN;
INSERT INTO parted_uniq_tbl VALUES (1);
SAVEPOINT f;
INSERT INTO parted_uniq_tbl VALUES (1);	-- unique violation
ERROR:  duplicate key value violates unique constraint "parted_uniq_tbl_1_i_key"
DETAIL:  Key (i)=(1) already exists.
ROLLBACK TO f;
SET CONSTRAINTS parted_uniq_tbl_i_key DEFERRED;
INSERT INTO parted_uniq_tbl VALUES (1);	-- OK now, fail at commit
COMMIT;
ERROR:  duplicate key value violates unique constraint "parted_uniq_tbl_1_i_key"
DETAIL:  Key (i)=(1) already exists.
DROP TABLE parted_uniq_tbl;
-- test a HOT update that invalidates the conflicting tuple.
-- the trigger should still fire and catch the violation
BEGIN;
INSERT INTO unique_tbl VALUES (3, 'Three'); -- should succeed for now
UPDATE unique_tbl SET t = 'THREE' WHERE i = 3 AND t = 'Three';
COMMIT; -- should fail
ERROR:  duplicate key value violates unique constraint "unique_tbl_i_key"
DETAIL:  Key (i)=(3) already exists.
SELECT * FROM unique_tbl;
 i |   t   
---+-------
 3 | three
 1 | five
 5 | one
 4 | two
 2 | four
(5 rows)

-- test a HOT update that modifies the newly inserted tuple,
-- but should succeed because we then remove the other conflicting tuple.
BEGIN;
INSERT INTO unique_tbl VALUES(3, 'tree'); -- should succeed for now
UPDATE unique_tbl SET t = 'threex' WHERE t = 'tree';
DELETE FROM unique_tbl WHERE t = 'three';
SELECT * FROM unique_tbl;
 i |   t    
---+--------
 1 | five
 5 | one
 4 | two
 2 | four
 3 | threex
(5 rows)

COMMIT;
SELECT * FROM unique_tbl;
 i |   t    
---+--------
 1 | five
 5 | one
 4 | two
 2 | four
 3 | threex
(5 rows)

DROP TABLE unique_tbl;
--
-- EXCLUDE constraints
--
CREATE TABLE circles (
  c1 CIRCLE,
  c2 TEXT,
  EXCLUDE USING gist
    (c1 WITH &&, (c2::circle) WITH &&)
    WHERE (circle_center(c1) <> '(0,0)')
);
-- these should succeed because they don't match the index predicate
INSERT INTO circles VALUES('<(0,0), 5>', '<(0,0), 5>');
INSERT INTO circles VALUES('<(0,0), 5>', '<(0,0), 4>');
-- succeed
INSERT INTO circles VALUES('<(10,10), 10>', '<(0,0), 5>');
-- fail, overlaps
INSERT INTO circles VALUES('<(20,20), 10>', '<(0,0), 4>');
ERROR:  conflicting key value violates exclusion constraint "circles_c1_c2_excl"
DETAIL:  Key (c1, (c2::circle))=(<(20,20),10>, <(0,0),4>) conflicts with existing key (c1, (c2::circle))=(<(10,10),10>, <(0,0),5>).
-- succeed, because violation is ignored
INSERT INTO circles VALUES('<(20,20), 10>', '<(0,0), 4>')
  ON CONFLICT ON CONSTRAINT circles_c1_c2_excl DO NOTHING;
-- fail, because DO UPDATE variant requires unique index
INSERT INTO circles VALUES('<(20,20), 10>', '<(0,0), 4>')
  ON CONFLICT ON CONSTRAINT circles_c1_c2_excl DO UPDATE SET c2 = EXCLUDED.c2;
ERROR:  ON CONFLICT DO UPDATE not supported with exclusion constraints
-- succeed because c1 doesn't overlap
INSERT INTO circles VALUES('<(20,20), 1>', '<(0,0), 5>');
-- succeed because c2 doesn't overlap
INSERT INTO circles VALUES('<(20,20), 10>', '<(10,10), 5>');
-- should fail on existing data without the WHERE clause
ALTER TABLE circles ADD EXCLUDE USING gist
  (c1 WITH &&, (c2::circle) WITH &&);
ERROR:  could not create exclusion constraint "circles_c1_c2_excl1"
DETAIL:  Key (c1, (c2::circle))=(<(0,0),5>, <(0,0),5>) conflicts with key (c1, (c2::circle))=(<(0,0),5>, <(0,0),4>).
-- try reindexing an existing constraint
REINDEX INDEX circles_c1_c2_excl;
DROP TABLE circles;
-- Check deferred exclusion constraint
CREATE TABLE deferred_excl (
  f1 int,
  f2 int,
  CONSTRAINT deferred_excl_con EXCLUDE (f1 WITH =) INITIALLY DEFERRED
);
INSERT INTO deferred_excl VALUES(1);
INSERT INTO deferred_excl VALUES(2);
INSERT INTO deferred_excl VALUES(1); -- fail
ERROR:  conflicting key value violates exclusion constraint "deferred_excl_con"
DETAIL:  Key (f1)=(1) conflicts with existing key (f1)=(1).
INSERT INTO deferred_excl VALUES(1) ON CONFLICT ON CONSTRAINT deferred_excl_con DO NOTHING; -- fail
ERROR:  ON CONFLICT does not support deferrable unique constraints/exclusion constraints as arbiters
BEGIN;
INSERT INTO deferred_excl VALUES(2); -- no fail here
COMMIT; -- should fail here
ERROR:  conflicting key value violates exclusion constraint "deferred_excl_con"
DETAIL:  Key (f1)=(2) conflicts with existing key (f1)=(2).
BEGIN;
INSERT INTO deferred_excl VALUES(3);
INSERT INTO deferred_excl VALUES(3); -- no fail here
COMMIT; -- should fail here
ERROR:  conflicting key value violates exclusion constraint "deferred_excl_con"
DETAIL:  Key (f1)=(3) conflicts with existing key (f1)=(3).
-- bug #13148: deferred constraint versus HOT update
BEGIN;
INSERT INTO deferred_excl VALUES(2, 1); -- no fail here
DELETE FROM deferred_excl WHERE f1 = 2 AND f2 IS NULL; -- remove old row
UPDATE deferred_excl SET f2 = 2 WHERE f1 = 2;
COMMIT; -- should not fail
SELECT * FROM deferred_excl;
 f1 | f2 
----+----
  1 |   
  2 |  2
(2 rows)

ALTER TABLE deferred_excl DROP CONSTRAINT deferred_excl_con;
-- This should fail, but worth testing because of HOT updates
UPDATE deferred_excl SET f1 = 3;
ALTER TABLE deferred_excl ADD EXCLUDE (f1 WITH =);
ERROR:  could not create exclusion constraint "deferred_excl_f1_excl"
DETAIL:  Key (f1)=(3) conflicts with key (f1)=(3).
DROP TABLE deferred_excl;
-- Comments
-- Setup a low-level role to enforce non-superuser checks.
CREATE ROLE regress_constraint_comments;
SET SESSION AUTHORIZATION regress_constraint_comments;
CREATE TABLE constraint_comments_tbl (a int CONSTRAINT the_constraint CHECK (a > 0));
CREATE DOMAIN constraint_comments_dom AS int CONSTRAINT the_constraint CHECK (value > 0);
COMMENT ON CONSTRAINT the_constraint ON constraint_comments_tbl IS 'yes, the comment';
COMMENT ON CONSTRAINT the_constraint ON DOMAIN constraint_comments_dom IS 'yes, another comment';
-- no such constraint
COMMENT ON CONSTRAINT no_constraint ON constraint_comments_tbl IS 'yes, the comment';
ERROR:  constraint "no_constraint" for table "constraint_comments_tbl" does not exist
COMMENT ON CONSTRAINT no_constraint ON DOMAIN constraint_comments_dom IS 'yes, another comment';
ERROR:  constraint "no_constraint" for domain constraint_comments_dom does not exist
-- no such table/domain
COMMENT ON CONSTRAINT the_constraint ON no_comments_tbl IS 'bad comment';
ERROR:  relation "no_comments_tbl" does not exist
COMMENT ON CONSTRAINT the_constraint ON DOMAIN no_comments_dom IS 'another bad comment';
ERROR:  type "no_comments_dom" does not exist
COMMENT ON CONSTRAINT the_constraint ON constraint_comments_tbl IS NULL;
COMMENT ON CONSTRAINT the_constraint ON DOMAIN constraint_comments_dom IS NULL;
-- unauthorized user
RESET SESSION AUTHORIZATION;
CREATE ROLE regress_constraint_comments_noaccess;
SET SESSION AUTHORIZATION regress_constraint_comments_noaccess;
COMMENT ON CONSTRAINT the_constraint ON constraint_comments_tbl IS 'no, the comment';
ERROR:  must be owner of relation constraint_comments_tbl
COMMENT ON CONSTRAINT the_constraint ON DOMAIN constraint_comments_dom IS 'no, another comment';
ERROR:  must be owner of type constraint_comments_dom
RESET SESSION AUTHORIZATION;
DROP TABLE constraint_comments_tbl;
DROP DOMAIN constraint_comments_dom;
DROP ROLE regress_constraint_comments;
DROP ROLE regress_constraint_comments_noaccess;
--
--
--
-- ALTER CONSTRAINT ... USING INDEX
--
--
--
CREATE FUNCTION show_some_indexes_from_relation(
	searched_relname name,
	searched_indnames name[]
)
RETURNS TABLE
(
	relname name,
	indname name,
	index_relkind "char",
	index_relispartition boolean,
	indisunique boolean,
	indisprimary boolean,
	indisexclusion boolean,
	indkey int2vector,
	indislive boolean,
	indisvalid boolean,
	indisready boolean,
	indoption int2vector,
	indcollation oidvector,
	indimmediate boolean,
	indisreplident boolean,
	depends_on_table boolean,
	depends_on_simple_columns boolean,
	depends_on_constraint boolean,
	conname name
)
AS $$
	SELECT r.relname, i.relname, i.relkind, i.relispartition, indisunique,
		   indisprimary, indisexclusion, indkey, indislive, indisvalid,
		   indisready, indoption, indcollation, indimmediate, indisreplident,
		   EXISTS(SELECT *
				  FROM pg_depend
				  WHERE classid = 'pg_class'::regclass AND
						objid = indexrelid AND
						refclassid = 'pg_class'::regclass AND
						refobjid = indrelid AND
						refobjsubid = 0),
		   EXISTS(SELECT *
				  FROM pg_depend
				  WHERE classid = 'pg_class'::regclass AND
						objid = indexrelid AND
						refclassid = 'pg_class'::regclass AND
						refobjid = indrelid AND
						refobjsubid != 0),
		   EXISTS(SELECT *
				  FROM pg_depend
				  WHERE classid = 'pg_class'::regclass AND
						objid = indexrelid AND
						refclassid = 'pg_constraint'::regclass AND
						refobjid = c.oid),
		   conname
	FROM pg_index
	JOIN pg_class i ON indexrelid = i.oid
	JOIN pg_class r ON indrelid = r.oid
	LEFT JOIN pg_constraint c ON indexrelid = c.conindid
	WHERE r.relname = searched_relname AND
		  (searched_indnames IS NULL OR i.relname = ANY (searched_indnames))
	ORDER BY indkey, i.relname;
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_indexes_from_relation(searched_relname name)
RETURNS TABLE
(
	relname name,
	indname name,
	index_relkind "char",
	index_relispartition boolean,
	indisunique boolean,
	indisprimary boolean,
	indisexclusion boolean,
	indkey int2vector,
	indislive boolean,
	indisvalid boolean,
	indisready boolean,
	indoption int2vector,
	indcollation oidvector,
	indimmediate boolean,
	indisreplident boolean,
	depends_on_table boolean,
	depends_on_simple_columns boolean,
	depends_on_constraint boolean,
	conname name
)
AS $$
	SELECT * FROM show_some_indexes_from_relation(searched_relname, NULL);
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_some_index_exprs_pred(
	searched_relname name,
	searched_indnames name[]
)
RETURNS TABLE
(
	relname name,
	indname name,
	indpred text,
	indexprs text
)
AS $$
	SELECT
		r.relname,
		i.relname,
		pg_get_expr(indpred, indrelid, true),
		pg_get_expr(indexprs, indrelid, true)
	FROM pg_index
	JOIN pg_class i ON indexrelid = i.oid
	JOIN pg_class r ON indrelid = r.oid
	WHERE r.relname = searched_relname AND
		  (searched_indnames IS NULL OR i.relname = ANY (searched_indnames))
	ORDER BY indexprs, indpred, indkey, i.relname;
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_index_exprs_pred(searched_relname name)
RETURNS TABLE
(
	relname name,
	indname name,
	indpred text,
	indexprs text
)
AS $$
	SELECT * FROM show_some_index_exprs_pred(searched_relname, NULL);
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_constraints_named_like(searched_conname name)
RETURNS TABLE
(
	conname name,
	contype "char",
	conkey smallint[],
	condeferrable boolean
)
AS $$
	SELECT conname, contype, conkey, condeferrable
	FROM pg_constraint
	WHERE conname LIKE searched_conname
	ORDER BY conkey, conname;
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_index_dependencies_on_table_columns
(
	searched_indnames name[]
)
RETURNS TABLE
(
	indname name,
	indnatts smallint,
	indnkeyatts smallint,
	indkey int2vector,
	attnum smallint,
	attname name
)
AS $$
	SELECT relname, indnatts, indnkeyatts, indkey, attnum, attname
	FROM pg_index
	JOIN pg_class ON indexrelid = pg_class.oid
	JOIN pg_depend ON indexrelid = objid
	JOIN pg_attribute ON attrelid = indrelid
	WHERE relname = ANY (searched_indnames) AND
		  classid = 'pg_class'::regclass AND
		  refclassid = 'pg_class'::regclass AND
		  refobjid = indrelid AND
		  refobjsubid != 0 AND
		  refobjsubid = attnum
	ORDER BY relname, refobjsubid;
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_alteridx_index_dependencies()
RETURNS TABLE
(
	indname name,
	referenced_indname name
)
AS $$
	SELECT c.relname, ref_c.relname
	FROM
		pg_index AS i
		JOIN pg_class AS c ON c.oid = i.indexrelid
		JOIN pg_depend ON objid = i.indexrelid
		JOIN pg_index AS ref_i ON refobjid = ref_i.indexrelid
		JOIN pg_class AS ref_c ON ref_c.oid = ref_i.indexrelid
	WHERE classid = 'pg_class'::regclass
		AND refclassid = 'pg_class'::regclass
		AND c.relname like '%alteridx%'
	ORDER BY c.relname, ref_c.relname;
$$ LANGUAGE SQL;
--
CREATE FUNCTION show_alteridx_constraint_dependencies()
RETURNS TABLE
(
	conname name,
	referenced_conname name
)
AS $$
	SELECT con.conname, ref_con.conname
	FROM
		pg_constraint AS con
		JOIN pg_depend ON objid = con.oid
		JOIN pg_constraint AS ref_con ON refobjid = ref_con.oid
	WHERE
		classid = 'pg_constraint'::regclass AND
		refclassid = 'pg_constraint'::regclass AND
		con.conname like '%alteridx%'
	ORDER BY con.conname, ref_con.conname;
$$ LANGUAGE SQL;
--
--
--
CREATE TABLE alteridx_orig(
id int PRIMARY KEY,
uniq int CONSTRAINT alteridx_orig_uniq_key UNIQUE NOT NULL,
parity int,
msg text UNIQUE,
ir int4range,
partition_key int,
EXCLUDE using gist(ir with &&),
EXCLUDE USING btree((id + uniq) WITH =) WHERE (id > 2),
EXCLUDE ((id + uniq) WITH =) WHERE (parity < 4),
CONSTRAINT alteridx_orig_double UNIQUE(id, uniq),
CONSTRAINT alteridx_id_key_deferrable UNIQUE (id) DEFERRABLE,
CHECK (parity > -10));
CREATE TABLE partitioned_orig_alteridx(
id int,
uniq int,
parity int,
msg text,
ir int4range,
partition_key int UNIQUE,
UNIQUE (partition_key, id))
PARTITION BY RANGE (partition_key);
ALTER TABLE partitioned_orig_alteridx ATTACH PARTITION alteridx_orig
FOR VALUES FROM (0) TO (20);
--
--
CREATE TABLE another_alteridx(
id int PRIMARY KEY,
uniq int UNIQUE,
parity int,
msg text,
ir int4range,
EXCLUDE USING gist(ir with &&),
EXCLUDE USING btree((id + 4) WITH =));
--
--
CREATE TABLE third_alteridx(
	id1 int,
	id2 int,
	PRIMARY KEY (id1, id2)
);
--
--
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_orig_double
 alteridx_orig | alteridx_orig_uniq_key             | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_uniq_key
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(10 rows)

SELECT * FROM show_index_exprs_pred('alteridx_orig');
    relname    |              indname               |  indpred   | indexprs  
---------------+------------------------------------+------------+-----------
 alteridx_orig | alteridx_orig_expr_excl            | id > 2     | id + uniq
 alteridx_orig | alteridx_orig_expr_excl1           | parity < 4 | id + uniq
 alteridx_orig | alteridx_id_key_deferrable         |            | 
 alteridx_orig | alteridx_orig_pkey                 |            | 
 alteridx_orig | alteridx_orig_double               |            | 
 alteridx_orig | alteridx_orig_uniq_key             |            | 
 alteridx_orig | alteridx_orig_msg_key              |            | 
 alteridx_orig | alteridx_orig_ir_excl              |            | 
 alteridx_orig | alteridx_orig_partition_key_key    |            | 
 alteridx_orig | alteridx_orig_partition_key_id_key |            | 
(10 rows)

SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key_deferrable         | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_orig_double               | u       | {1,2}  | f
 alteridx_orig_uniq_key             | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(11 rows)

SELECT * FROM show_indexes_from_relation('partitioned_orig_alteridx');
          relname          |                    indname                     | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |                    conname                     
---------------------------+------------------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------------------
 partitioned_orig_alteridx | partitioned_orig_alteridx_partition_key_key    | I             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | partitioned_orig_alteridx_partition_key_key
 partitioned_orig_alteridx | partitioned_orig_alteridx_partition_key_id_key | I             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | partitioned_orig_alteridx_partition_key_id_key
(2 rows)

SELECT * FROM show_constraints_named_like('partitioned_%');
                    conname                     | contype | conkey | condeferrable 
------------------------------------------------+---------+--------+---------------
 partitioned_orig_alteridx_partition_key_key    | u       | {6}    | f
 partitioned_orig_alteridx_partition_key_id_key | u       | {6,1}  | f
(2 rows)

SELECT * FROM show_indexes_from_relation('another_alteridx');
     relname      |          indname           | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |          conname           
------------------+----------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+----------------------------
 another_alteridx | another_alteridx_expr_excl | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | another_alteridx_expr_excl
 another_alteridx | another_alteridx_pkey      | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_pkey
 another_alteridx | another_alteridx_uniq_key  | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_uniq_key
 another_alteridx | another_alteridx_ir_excl   | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_ir_excl
(4 rows)

SELECT * FROM show_constraints_named_like('another_%');
          conname           | contype | conkey | condeferrable 
----------------------------+---------+--------+---------------
 another_alteridx_expr_excl | x       | {0}    | f
 another_alteridx_pkey      | p       | {1}    | f
 another_alteridx_uniq_key  | u       | {2}    | f
 another_alteridx_ir_excl   | x       | {5}    | f
(4 rows)

--
--
-- Checking that constraints work before index replacement
--
--
INSERT INTO alteridx_orig SELECT n, n, n%2, CHR(62+n) || CHR(63+n),
int4range(2*n,2*n+1), n from generate_series(1,10) as gs(n);
INSERT INTO another_alteridx SELECT n, n, n%2, CHR(62+n) || CHR(63+n),
int4range(2*n,2*n+1) from generate_series(1,10) as gs(n);
--
INSERT INTO alteridx_orig VALUES(1, 0, 1, 'AA', int4range(102, 103), 15); -- failure here
ERROR:  duplicate key value violates unique constraint "alteridx_orig_pkey"
DETAIL:  Key (id)=(1) already exists.
INSERT INTO alteridx_orig VALUES(0, 1, 1, 'AA', int4range(104, 105), 15); -- failure here
ERROR:  duplicate key value violates unique constraint "alteridx_orig_uniq_key"
DETAIL:  Key (uniq)=(1) already exists.
INSERT INTO alteridx_orig VALUES(0, 0, 1, 'AA', int4range(1, 107), 15); -- failure here
ERROR:  conflicting key value violates exclusion constraint "alteridx_orig_ir_excl"
DETAIL:  Key (ir)=([1,107)) conflicts with existing key (ir)=([2,3)).
INSERT INTO alteridx_orig VALUES(NULL, 0, 1, 'AA', int4range(102, 107), 15); -- failure here
ERROR:  null value in column "id" of relation "alteridx_orig" violates not-null constraint
DETAIL:  Failing row contains (null, 0, 1, AA, [102,107), 15).
INSERT INTO alteridx_orig VALUES(0, NULL, 1, 'AA', int4range(102, 107), 15); -- failure here
ERROR:  null value in column "uniq" of relation "alteridx_orig" violates not-null constraint
DETAIL:  Failing row contains (0, null, 1, AA, [102,107), 15).
INSERT INTO alteridx_orig VALUES(0, 0, 1, 'AA', int4range(102, 107), 15);
SELECT * FROM alteridx_orig;
 id | uniq | parity | msg |    ir     | partition_key 
----+------+--------+-----+-----------+---------------
  1 |    1 |      1 | ?@  | [2,3)     |             1
  2 |    2 |      0 | @A  | [4,5)     |             2
  3 |    3 |      1 | AB  | [6,7)     |             3
  4 |    4 |      0 | BC  | [8,9)     |             4
  5 |    5 |      1 | CD  | [10,11)   |             5
  6 |    6 |      0 | DE  | [12,13)   |             6
  7 |    7 |      1 | EF  | [14,15)   |             7
  8 |    8 |      0 | FG  | [16,17)   |             8
  9 |    9 |      1 | GH  | [18,19)   |             9
 10 |   10 |      0 | HI  | [20,21)   |            10
  0 |    0 |      1 | AA  | [102,107) |            15
(11 rows)

--
--
CREATE UNIQUE INDEX alteridx_new_uniq_key ON alteridx_orig(uniq);
CREATE UNIQUE INDEX alteridx_new_uniq_key_incl ON alteridx_orig(uniq) INCLUDE (ir);
CREATE UNIQUE INDEX alteridx_new_uniq_key_incl2 ON alteridx_orig(uniq) INCLUDE (parity);
CREATE UNIQUE INDEX CONCURRENTLY alteridx_new_uniq_key_back ON alteridx_orig USING BTREE(uniq);
CREATE UNIQUE INDEX alteridx_new_uniq_key_pred ON alteridx_orig(uniq) WHERE parity=1;
CREATE INDEX alteridx_new_uniq_key_no_unique ON alteridx_orig(uniq);
CREATE UNIQUE INDEX alteridx_new_uniq_key_with_msg ON alteridx_orig(uniq, msg);
CREATE UNIQUE INDEX alteridx_new_msg_key_ops ON alteridx_orig(msg text_pattern_ops);
CREATE UNIQUE INDEX alteridx_new_pkey ON alteridx_orig(id);
CREATE INDEX alteridx_new_ir_excl ON alteridx_orig using gist(ir range_ops);
CREATE INDEX alteridx_new_expr_excl ON alteridx_orig((id + uniq)) WHERE (id > 2);
CREATE INDEX alteridx_new_expr_excl_hash ON alteridx_orig USING hash((id + uniq)) WHERE (id > 2);
CREATE INDEX alteridx_new_expr_excl_pred ON alteridx_orig((id + uniq)) WHERE (id > 3);
CREATE INDEX alteridx_new_expr_excl_pred2 ON alteridx_orig((id + uniq)) WHERE (id > (3 - 1));
CREATE INDEX alteridx_new_expr_excl_wrong ON alteridx_orig((id - uniq)) WHERE (id > 2);
CREATE INDEX alteridx_new_expr_excl1 ON alteridx_orig((id + uniq)) WHERE (parity < 4);
CREATE INDEX another_alteridx_new_expr_excl ON another_alteridx((id + 4));
CREATE INDEX another_alteridx_new_expr_excl_different ON another_alteridx((id + 2 + 2));
CREATE INDEX another_alteridx_new_expr_excl_different2 ON another_alteridx((id + (2 + 2)));
CREATE UNIQUE INDEX alteridx_new_double ON alteridx_orig(id, uniq);
CREATE INDEX alteridx_new_double_not_unique ON alteridx_orig(id, uniq);
CREATE UNIQUE INDEX alteridx_id_key ON alteridx_orig(id);
--
CREATE UNIQUE INDEX third_alteridx_pkey_new ON third_alteridx(id1, id2);
CREATE UNIQUE INDEX third_alteridx_pkey_opp ON third_alteridx(id2, id1);
CREATE UNIQUE INDEX third_alteridx_pkey_single ON third_alteridx(id1);
CREATE INDEX third_alteridx_pkey_not_unique ON third_alteridx(id1, id2);
--
CREATE UNIQUE INDEX alteridx_new_partition_key_key
ON alteridx_orig(partition_key);
CREATE UNIQUE INDEX alteridx_new_partition_key_id_key
ON alteridx_orig(partition_key,id);
CREATE UNIQUE INDEX partitioned_new_alteridx_partition_key_key
ON partitioned_orig_alteridx(partition_key);
CREATE UNIQUE INDEX partitioned_new_alteridx_partition_key_id_key
ON partitioned_orig_alteridx(partition_key,id);
--
CREATE UNIQUE INDEX alteridx_new_uniq_key_opt ON alteridx_orig(uniq);
UPDATE pg_index SET indoption='1'
FROM pg_class i WHERE indexrelid = i.oid AND i.relname = 'alteridx_new_uniq_key_opt';
CREATE UNIQUE INDEX alteridx_new_msg_key_coll ON alteridx_orig(msg);
UPDATE pg_index SET indcollation='12341'
FROM pg_class i WHERE indexrelid = i.oid AND i.relname = 'alteridx_new_msg_key_coll';
--
--
-- Tests for unique constraint --
--
--
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_orig_double
 alteridx_orig | alteridx_new_uniq_key              | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_pred         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_uniq_key             | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_uniq_key
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(33 rows)

SELECT * FROM show_index_exprs_pred('alteridx_orig');
    relname    |              indname               |   indpred    | indexprs  
---------------+------------------------------------+--------------+-----------
 alteridx_orig | alteridx_orig_expr_excl            | id > 2       | id + uniq
 alteridx_orig | alteridx_orig_expr_excl1           | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl             | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl1            | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred        | id > 3       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred2       | id > (3 - 1) | id + uniq
 alteridx_orig | alteridx_new_expr_excl_hash        | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_wrong       | id > 2       | id - uniq
 alteridx_orig | alteridx_new_uniq_key_pred         | parity = 1   | 
 alteridx_orig | alteridx_id_key                    |              | 
 alteridx_orig | alteridx_id_key_deferrable         |              | 
 alteridx_orig | alteridx_new_pkey                  |              | 
 alteridx_orig | alteridx_orig_pkey                 |              | 
 alteridx_orig | alteridx_new_double                |              | 
 alteridx_orig | alteridx_new_double_not_unique     |              | 
 alteridx_orig | alteridx_orig_double               |              | 
 alteridx_orig | alteridx_new_uniq_key              |              | 
 alteridx_orig | alteridx_new_uniq_key_back         |              | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    |              | 
 alteridx_orig | alteridx_new_uniq_key_opt          |              | 
 alteridx_orig | alteridx_orig_uniq_key             |              | 
 alteridx_orig | alteridx_new_uniq_key_incl2        |              | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     |              | 
 alteridx_orig | alteridx_new_uniq_key_incl         |              | 
 alteridx_orig | alteridx_new_msg_key_coll          |              | 
 alteridx_orig | alteridx_new_msg_key_ops           |              | 
 alteridx_orig | alteridx_orig_msg_key              |              | 
 alteridx_orig | alteridx_new_ir_excl               |              | 
 alteridx_orig | alteridx_orig_ir_excl              |              | 
 alteridx_orig | alteridx_new_partition_key_key     |              | 
 alteridx_orig | alteridx_orig_partition_key_key    |              | 
 alteridx_orig | alteridx_new_partition_key_id_key  |              | 
 alteridx_orig | alteridx_orig_partition_key_id_key |              | 
(33 rows)

SELECT * FROM show_index_dependencies_on_table_columns(
	'{"alteridx_new_uniq_key_incl",
	  "alteridx_new_uniq_key_incl2",
	  "alteridx_orig_expr_excl1",
	  "alteridx_new_expr_excl1"}'::name[]);
           indname           | indnatts | indnkeyatts | indkey | attnum | attname 
-----------------------------+----------+-------------+--------+--------+---------
 alteridx_new_expr_excl1     |        1 |           1 | 0      |      1 | id
 alteridx_new_expr_excl1     |        1 |           1 | 0      |      2 | uniq
 alteridx_new_expr_excl1     |        1 |           1 | 0      |      3 | parity
 alteridx_new_uniq_key_incl  |        2 |           1 | 2 5    |      2 | uniq
 alteridx_new_uniq_key_incl  |        2 |           1 | 2 5    |      5 | ir
 alteridx_new_uniq_key_incl2 |        2 |           1 | 2 3    |      2 | uniq
 alteridx_new_uniq_key_incl2 |        2 |           1 | 2 3    |      3 | parity
 alteridx_orig_expr_excl1    |        1 |           1 | 0      |      1 | id
 alteridx_orig_expr_excl1    |        1 |           1 | 0      |      2 | uniq
 alteridx_orig_expr_excl1    |        1 |           1 | 0      |      3 | parity
(10 rows)

SELECT * FROM show_indexes_from_relation('partitioned_orig_alteridx');
          relname          |                    indname                     | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |                    conname                     
---------------------------+------------------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------------------
 partitioned_orig_alteridx | partitioned_new_alteridx_partition_key_key     | I             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 partitioned_orig_alteridx | partitioned_orig_alteridx_partition_key_key    | I             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | partitioned_orig_alteridx_partition_key_key
 partitioned_orig_alteridx | partitioned_new_alteridx_partition_key_id_key  | I             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 partitioned_orig_alteridx | partitioned_orig_alteridx_partition_key_id_key | I             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | partitioned_orig_alteridx_partition_key_id_key
(4 rows)

SELECT * FROM show_indexes_from_relation('another_alteridx');
     relname      |                  indname                  | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |          conname           
------------------+-------------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+----------------------------
 another_alteridx | another_alteridx_expr_excl                | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | another_alteridx_expr_excl
 another_alteridx | another_alteridx_new_expr_excl            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 another_alteridx | another_alteridx_new_expr_excl_different  | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 another_alteridx | another_alteridx_new_expr_excl_different2 | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 another_alteridx | another_alteridx_pkey                     | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_pkey
 another_alteridx | another_alteridx_uniq_key                 | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_uniq_key
 another_alteridx | another_alteridx_ir_excl                  | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_ir_excl
(7 rows)

SELECT * FROM show_index_exprs_pred('another_alteridx');
     relname      |                  indname                  | indpred |   indexprs   
------------------+-------------------------------------------+---------+--------------
 another_alteridx | another_alteridx_new_expr_excl_different  |         | id + 2 + 2
 another_alteridx | another_alteridx_expr_excl                |         | id + 4
 another_alteridx | another_alteridx_new_expr_excl            |         | id + 4
 another_alteridx | another_alteridx_new_expr_excl_different2 |         | id + (2 + 2)
 another_alteridx | another_alteridx_pkey                     |         | 
 another_alteridx | another_alteridx_uniq_key                 |         | 
 another_alteridx | another_alteridx_ir_excl                  |         | 
(7 rows)

SELECT * FROM show_constraints_named_like('another_%');
          conname           | contype | conkey | condeferrable 
----------------------------+---------+--------+---------------
 another_alteridx_expr_excl | x       | {0}    | f
 another_alteridx_pkey      | p       | {1}    | f
 another_alteridx_uniq_key  | u       | {2}    | f
 another_alteridx_ir_excl   | x       | {5}    | f
(4 rows)

DROP INDEX alteridx_orig_uniq_key; -- failure here
ERROR:  cannot drop index alteridx_orig_uniq_key because constraint alteridx_orig_uniq_key on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_orig_uniq_key on table alteridx_orig instead.
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key_deferrable         | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_orig_double               | u       | {1,2}  | f
 alteridx_orig_uniq_key             | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(11 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_parity_check
USING INDEX alteridx_new_uniq_key; -- failure here
ERROR:  constraint "alteridx_orig_parity_check" of relation "alteridx_orig" is not a primary key, unique constraint, exclusion constraint or foreign constraint
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_uniq_key
USING INDEX alteridx_orig_uniq_key;
NOTICE:  constraint "alteridx_orig_uniq_key" already uses index "alteridx_orig_uniq_key", skipping
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_uniq_key
USING INDEX alteridx_new_uniq_key;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_uniq_key" to "alteridx_new_uniq_key"
--
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key_deferrable         | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_orig_double               | u       | {1,2}  | f
 alteridx_new_uniq_key              | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(11 rows)

SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_orig_double
 alteridx_orig | alteridx_new_uniq_key              | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_pred         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_uniq_key             | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(33 rows)

DROP INDEX alteridx_orig_uniq_key;
DROP INDEX alteridx_new_uniq_key; -- failure here
ERROR:  cannot drop index alteridx_new_uniq_key because constraint alteridx_new_uniq_key on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_new_uniq_key on table alteridx_orig instead.
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_orig_double
 alteridx_orig | alteridx_new_uniq_key              | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_pred         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(32 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key
USING INDEX alteridx_new_uniq_key_incl2;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_new_uniq_key" to "alteridx_new_uniq_key_incl2"
--
--
-- Checking that all dependencies on simply-referenced columns are correctly
-- added for old constraint index (included columns may differ in the old and
-- new constraint index).
--
--
SELECT * FROM show_some_indexes_from_relation(
	'alteridx_orig',
	'{"alteridx_new_uniq_key_incl", "alteridx_new_uniq_key_incl2"}'::name[]);
    relname    |           indname           | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |           conname           
---------------+-----------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-----------------------------
 alteridx_orig | alteridx_new_uniq_key_incl2 | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_incl2
 alteridx_orig | alteridx_new_uniq_key_incl  | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
(2 rows)

SELECT * FROM show_index_dependencies_on_table_columns(
	'{"alteridx_new_uniq_key_incl", "alteridx_new_uniq_key_incl2"}'::name[]);
          indname           | indnatts | indnkeyatts | indkey | attnum | attname 
----------------------------+----------+-------------+--------+--------+---------
 alteridx_new_uniq_key_incl |        2 |           1 | 2 5    |      2 | uniq
 alteridx_new_uniq_key_incl |        2 |           1 | 2 5    |      5 | ir
(2 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_incl2
USING INDEX alteridx_new_uniq_key_incl;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_new_uniq_key_incl2" to "alteridx_new_uniq_key_incl"
SELECT * FROM show_some_indexes_from_relation(
	'alteridx_orig',
	'{"alteridx_new_uniq_key_incl", "alteridx_new_uniq_key_incl2"}'::name[]);
    relname    |           indname           | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |          conname           
---------------+-----------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+----------------------------
 alteridx_orig | alteridx_new_uniq_key_incl2 | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl  | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_incl
(2 rows)

SELECT * FROM show_index_dependencies_on_table_columns(
	'{"alteridx_new_uniq_key_incl", "alteridx_new_uniq_key_incl2"}'::name[]);
           indname           | indnatts | indnkeyatts | indkey | attnum | attname 
-----------------------------+----------+-------------+--------+--------+---------
 alteridx_new_uniq_key_incl2 |        2 |           1 | 2 3    |      2 | uniq
 alteridx_new_uniq_key_incl2 |        2 |           1 | 2 3    |      3 | parity
(2 rows)

--
DROP INDEX alteridx_new_uniq_key;
DROP INDEX alteridx_new_uniq_key_incl; -- failure here
ERROR:  cannot drop index alteridx_new_uniq_key_incl because constraint alteridx_new_uniq_key_incl on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_new_uniq_key_incl on table alteridx_orig instead.
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key_deferrable         | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_orig_double               | u       | {1,2}  | f
 alteridx_new_uniq_key_incl         | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(11 rows)

SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_orig_double
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_pred         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_incl
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(31 rows)

SELECT * FROM show_index_exprs_pred('alteridx_orig');
    relname    |              indname               |   indpred    | indexprs  
---------------+------------------------------------+--------------+-----------
 alteridx_orig | alteridx_orig_expr_excl            | id > 2       | id + uniq
 alteridx_orig | alteridx_orig_expr_excl1           | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl             | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl1            | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred        | id > 3       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred2       | id > (3 - 1) | id + uniq
 alteridx_orig | alteridx_new_expr_excl_hash        | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_wrong       | id > 2       | id - uniq
 alteridx_orig | alteridx_new_uniq_key_pred         | parity = 1   | 
 alteridx_orig | alteridx_id_key                    |              | 
 alteridx_orig | alteridx_id_key_deferrable         |              | 
 alteridx_orig | alteridx_new_pkey                  |              | 
 alteridx_orig | alteridx_orig_pkey                 |              | 
 alteridx_orig | alteridx_new_double                |              | 
 alteridx_orig | alteridx_new_double_not_unique     |              | 
 alteridx_orig | alteridx_orig_double               |              | 
 alteridx_orig | alteridx_new_uniq_key_back         |              | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    |              | 
 alteridx_orig | alteridx_new_uniq_key_opt          |              | 
 alteridx_orig | alteridx_new_uniq_key_incl2        |              | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     |              | 
 alteridx_orig | alteridx_new_uniq_key_incl         |              | 
 alteridx_orig | alteridx_new_msg_key_coll          |              | 
 alteridx_orig | alteridx_new_msg_key_ops           |              | 
 alteridx_orig | alteridx_orig_msg_key              |              | 
 alteridx_orig | alteridx_new_ir_excl               |              | 
 alteridx_orig | alteridx_orig_ir_excl              |              | 
 alteridx_orig | alteridx_new_partition_key_key     |              | 
 alteridx_orig | alteridx_orig_partition_key_key    |              | 
 alteridx_orig | alteridx_new_partition_key_id_key  |              | 
 alteridx_orig | alteridx_orig_partition_key_id_key |              | 
(31 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_incl
USING INDEX alteridx_new_uniq_key_back;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_new_uniq_key_incl" to "alteridx_new_uniq_key_back"
--
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key_deferrable         | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_orig_double               | u       | {1,2}  | f
 alteridx_new_uniq_key_back         | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(11 rows)

--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_pred; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_pred"
DETAIL:  Either none or both indexes must have partial index predicates.
DROP INDEX alteridx_new_uniq_key_pred;
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_no_unique; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_no_unique"
DETAIL:  Both indexes must be either unique or not.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_msg_key
USING INDEX alteridx_new_msg_key_coll; -- failure here
ERROR:  index in constraint "alteridx_orig_msg_key" cannot be replaced by "alteridx_new_msg_key_coll"
DETAIL:  Indexes must have the same collation.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_msg_key
USING INDEX alteridx_new_msg_key_ops; -- failure here
ERROR:  index in constraint "alteridx_orig_msg_key" cannot be replaced by "alteridx_new_msg_key_ops"
DETAIL:  Indexes must have the same operator class.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_msg_key
USING INDEX alteridx_new_uniq_key_incl; -- failure here
ERROR:  index in constraint "alteridx_orig_msg_key" cannot be replaced by "alteridx_new_uniq_key_incl"
DETAIL:  Indexes must have the same key columns.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX another_alteridx_uniq_key; -- failure here
ERROR:  "another_alteridx_uniq_key" is not an index for table "alteridx_orig"
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_with_msg; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_with_msg"
DETAIL:  Indexes must have the same number of key columns.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_opt; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_opt"
DETAIL:  Indexes must have the same per-column flag bits.
--
--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_double
USING INDEX alteridx_new_uniq_key_incl; -- failure here
ERROR:  index in constraint "alteridx_orig_double" cannot be replaced by "alteridx_new_uniq_key_incl"
DETAIL:  Indexes must have the same number of key columns.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_double
USING INDEX alteridx_new_double_not_unique; -- failure here
ERROR:  index in constraint "alteridx_orig_double" cannot be replaced by "alteridx_new_double_not_unique"
DETAIL:  Both indexes must be either unique or not.
--
--
-- Checking the notification if the replica identity index is no longer used in
-- the constraint.
--
--
ALTER TABLE alteridx_orig REPLICA IDENTITY USING INDEX alteridx_orig_double;
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | t              | f                | f                         | t                     | alteridx_orig_double
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(30 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_double
USING INDEX alteridx_new_double;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_double" to "alteridx_new_double"
NOTICE:  replaced index "alteridx_orig_double" is still chosen as replica identity
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_double
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | t              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(30 rows)

--
--
-- Checking that deferrable constraints cannot use replica identity index
--
--
ALTER TABLE alteridx_orig REPLICA IDENTITY USING INDEX alteridx_id_key;
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | t              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_double
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(30 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_id_key_deferrable
USING INDEX alteridx_id_key; -- failure here
ERROR:  index in constraint "alteridx_id_key_deferrable" cannot be replaced by "alteridx_id_key"
DETAIL:  Deferrable constraint cannot use replica identity index.
ALTER TABLE alteridx_orig REPLICA IDENTITY DEFAULT;
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key_deferrable
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_double
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(30 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_id_key_deferrable
USING INDEX alteridx_id_key;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_id_key_deferrable" to "alteridx_id_key"
--
--
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key                    | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_new_double                | u       | {1,2}  | f
 alteridx_new_uniq_key_back         | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(11 rows)

SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_hash        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred        | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_new_expr_excl_wrong       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_double                | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_double
 alteridx_orig | alteridx_new_double_not_unique     | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_double               | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(30 rows)

ALTER TABLE alteridx_orig DROP CONSTRAINT alteridx_orig_double; -- failure here
ERROR:  constraint "alteridx_orig_double" of relation "alteridx_orig" does not exist
ALTER TABLE alteridx_orig DROP CONSTRAINT alteridx_new_double;
DROP INDEX alteridx_orig_double;
DROP INDEX alteridx_new_double_not_unique;
--
--
-- Tests for primary key constraint --
--
--
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key                    | u       | {1}    | t
 alteridx_orig_pkey                 | p       | {1}    | f
 alteridx_new_uniq_key_back         | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(10 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_pkey
USING INDEX alteridx_new_pkey;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_pkey" to "alteridx_new_pkey"
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key                    | u       | {1}    | t
 alteridx_new_pkey                  | p       | {1}    | f
 alteridx_new_uniq_key_back         | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_orig_ir_excl              | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(10 rows)

--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_pkey
USING INDEX another_alteridx_uniq_key; -- failure here
ERROR:  "another_alteridx_uniq_key" is not an index for table "alteridx_orig"
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_pkey
USING INDEX another_alteridx_pkey; -- failure here
ERROR:  "another_alteridx_pkey" is not an index for table "alteridx_orig"
--
SELECT * FROM show_indexes_from_relation('third_alteridx');
    relname     |            indname             | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |       conname       
----------------+--------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+---------------------
 third_alteridx | third_alteridx_pkey_single     | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 third_alteridx | third_alteridx_pkey            | i             | f                    | t           | t            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | third_alteridx_pkey
 third_alteridx | third_alteridx_pkey_new        | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 third_alteridx | third_alteridx_pkey_not_unique | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 third_alteridx | third_alteridx_pkey_opp        | i             | f                    | t           | f            | f              | 2 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
(5 rows)

SELECT * FROM show_constraints_named_like('third_%');
       conname       | contype | conkey | condeferrable 
---------------------+---------+--------+---------------
 third_alteridx_pkey | p       | {1,2}  | f
(1 row)

ALTER TABLE third_alteridx ALTER CONSTRAINT third_alteridx_pkey
USING INDEX third_alteridx_pkey_opp; -- failure here
ERROR:  index in constraint "third_alteridx_pkey" cannot be replaced by "third_alteridx_pkey_opp"
DETAIL:  Indexes must have the same key columns.
ALTER TABLE third_alteridx ALTER CONSTRAINT third_alteridx_pkey
USING INDEX third_alteridx_pkey_not_unique; -- failure here
ERROR:  index in constraint "third_alteridx_pkey" cannot be replaced by "third_alteridx_pkey_not_unique"
DETAIL:  Both indexes must be either unique or not.
ALTER TABLE third_alteridx ALTER CONSTRAINT third_alteridx_pkey
USING INDEX third_alteridx_pkey_single; -- failure here
ERROR:  index in constraint "third_alteridx_pkey" cannot be replaced by "third_alteridx_pkey_single"
DETAIL:  Indexes must have the same number of key columns.
ALTER TABLE third_alteridx ALTER CONSTRAINT third_alteridx_pkey
USING INDEX third_alteridx_pkey_new;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "third_alteridx_pkey" to "third_alteridx_pkey_new"
SELECT * FROM show_indexes_from_relation('third_alteridx');
    relname     |            indname             | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |         conname         
----------------+--------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-------------------------
 third_alteridx | third_alteridx_pkey_single     | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 third_alteridx | third_alteridx_pkey            | i             | f                    | t           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 third_alteridx | third_alteridx_pkey_new        | i             | f                    | t           | t            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | third_alteridx_pkey_new
 third_alteridx | third_alteridx_pkey_not_unique | i             | f                    | f           | f            | f              | 1 2    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 third_alteridx | third_alteridx_pkey_opp        | i             | f                    | t           | f            | f              | 2 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
(5 rows)

SELECT * FROM show_constraints_named_like('third_%');
         conname         | contype | conkey | condeferrable 
-------------------------+---------+--------+---------------
 third_alteridx_pkey_new | p       | {1,2}  | f
(1 row)

--
--
-- Tests for exclusion constraint --
--
--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_ir_excl
USING INDEX alteridx_new_ir_excl;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_ir_excl" to "alteridx_new_ir_excl"
SELECT * FROM show_constraints_named_like('alteridx_%');
              conname               | contype | conkey | condeferrable 
------------------------------------+---------+--------+---------------
 alteridx_orig_expr_excl            | x       | {0}    | f
 alteridx_orig_expr_excl1           | x       | {0}    | f
 alteridx_id_key                    | u       | {1}    | t
 alteridx_new_pkey                  | p       | {1}    | f
 alteridx_new_uniq_key_back         | u       | {2}    | f
 alteridx_orig_parity_check         | c       | {3}    | f
 alteridx_orig_msg_key              | u       | {4}    | f
 alteridx_new_ir_excl               | x       | {5}    | f
 alteridx_orig_partition_key_key    | u       | {6}    | f
 alteridx_orig_partition_key_id_key | u       | {6,1}  | f
(10 rows)

--
ALTER TABLE alteridx_orig ADD CONSTRAINT alteridx_new_expr_excl2
EXCLUDE ((id + uniq) WITH =) WHERE (id > 2);
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_new_expr_excl2; -- failure here
ERROR:  index "alteridx_new_expr_excl2" is already associated with a constraint
ALTER TABLE alteridx_orig DROP CONSTRAINT alteridx_new_expr_excl2;
--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_orig_ir_excl; -- failure here
ERROR:  index in constraint "alteridx_orig_expr_excl" cannot be replaced by "alteridx_orig_ir_excl"
DETAIL:  Indexes must have the same access methods.
--
--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_new_expr_excl_wrong; -- failure here
ERROR:  index in constraint "alteridx_orig_expr_excl" cannot be replaced by "alteridx_new_expr_excl_wrong"
DETAIL:  Indexes must have the same non-column attributes.
--
--
-- Checking that after simplifying the constants from index predicates some
-- indexes are considered equal.
--
--
SELECT * FROM show_some_index_exprs_pred(
	'alteridx_orig',
	'{"alteridx_orig_expr_excl",
	  "alteridx_new_expr_excl_pred",
	  "alteridx_new_expr_excl_pred2"}'::name[]);
    relname    |           indname            |   indpred    | indexprs  
---------------+------------------------------+--------------+-----------
 alteridx_orig | alteridx_orig_expr_excl      | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred  | id > 3       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred2 | id > (3 - 1) | id + uniq
(3 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_new_expr_excl_pred; -- failure here
ERROR:  index in constraint "alteridx_orig_expr_excl" cannot be replaced by "alteridx_new_expr_excl_pred"
DETAIL:  Indexes must have the same partial index predicates.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_new_expr_excl_pred2;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_expr_excl" to "alteridx_new_expr_excl_pred2"
--
--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_expr_excl_pred2
USING INDEX alteridx_new_expr_excl_hash; -- failure here
ERROR:  index in constraint "alteridx_new_expr_excl_pred2" cannot be replaced by "alteridx_new_expr_excl_hash"
DETAIL:  Indexes must have the same access methods.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_expr_excl_pred2
USING INDEX alteridx_new_expr_excl;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_new_expr_excl_pred2" to "alteridx_new_expr_excl"
--
--
-- Checking that all dependencies on columns from index expressions and/or index
-- predicate are not removed for new constraint index (they always exist both
-- for standalone and constraint indexes).
--
--
SELECT * FROM show_some_indexes_from_relation(
	'alteridx_orig',
	'{"alteridx_orig_expr_excl1", "alteridx_new_expr_excl1"}'::name[]);
    relname    |         indname          | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |         conname          
---------------+--------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+--------------------------
 alteridx_orig | alteridx_new_expr_excl1  | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1 | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_orig_expr_excl1
(2 rows)

SELECT * FROM show_index_dependencies_on_table_columns(
	'{"alteridx_orig_expr_excl1", "alteridx_new_expr_excl1"}'::name[]);
         indname          | indnatts | indnkeyatts | indkey | attnum | attname 
--------------------------+----------+-------------+--------+--------+---------
 alteridx_new_expr_excl1  |        1 |           1 | 0      |      1 | id
 alteridx_new_expr_excl1  |        1 |           1 | 0      |      2 | uniq
 alteridx_new_expr_excl1  |        1 |           1 | 0      |      3 | parity
 alteridx_orig_expr_excl1 |        1 |           1 | 0      |      1 | id
 alteridx_orig_expr_excl1 |        1 |           1 | 0      |      2 | uniq
 alteridx_orig_expr_excl1 |        1 |           1 | 0      |      3 | parity
(6 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl1
USING INDEX alteridx_new_expr_excl1;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_expr_excl1" to "alteridx_new_expr_excl1"
SELECT * FROM show_some_indexes_from_relation(
	'alteridx_orig',
	'{"alteridx_orig_expr_excl1", "alteridx_new_expr_excl1"}'::name[]);
    relname    |         indname          | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |         conname         
---------------+--------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-------------------------
 alteridx_orig | alteridx_new_expr_excl1  | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_orig_expr_excl1 | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
(2 rows)

SELECT * FROM show_index_dependencies_on_table_columns(
	'{"alteridx_orig_expr_excl1", "alteridx_new_expr_excl1"}'::name[]);
         indname          | indnatts | indnkeyatts | indkey | attnum | attname 
--------------------------+----------+-------------+--------+--------+---------
 alteridx_new_expr_excl1  |        1 |           1 | 0      |      1 | id
 alteridx_new_expr_excl1  |        1 |           1 | 0      |      2 | uniq
 alteridx_new_expr_excl1  |        1 |           1 | 0      |      3 | parity
 alteridx_orig_expr_excl1 |        1 |           1 | 0      |      1 | id
 alteridx_orig_expr_excl1 |        1 |           1 | 0      |      2 | uniq
 alteridx_orig_expr_excl1 |        1 |           1 | 0      |      3 | parity
(6 rows)

--
--
SELECT * FROM show_index_exprs_pred('alteridx_orig');
    relname    |              indname               |   indpred    | indexprs  
---------------+------------------------------------+--------------+-----------
 alteridx_orig | alteridx_orig_expr_excl            | id > 2       | id + uniq
 alteridx_orig | alteridx_orig_expr_excl1           | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl             | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl1            | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred        | id > 3       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred2       | id > (3 - 1) | id + uniq
 alteridx_orig | alteridx_new_expr_excl_hash        | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl_wrong       | id > 2       | id - uniq
 alteridx_orig | alteridx_id_key                    |              | 
 alteridx_orig | alteridx_id_key_deferrable         |              | 
 alteridx_orig | alteridx_new_pkey                  |              | 
 alteridx_orig | alteridx_orig_pkey                 |              | 
 alteridx_orig | alteridx_new_uniq_key_back         |              | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    |              | 
 alteridx_orig | alteridx_new_uniq_key_opt          |              | 
 alteridx_orig | alteridx_new_uniq_key_incl2        |              | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     |              | 
 alteridx_orig | alteridx_new_uniq_key_incl         |              | 
 alteridx_orig | alteridx_new_msg_key_coll          |              | 
 alteridx_orig | alteridx_new_msg_key_ops           |              | 
 alteridx_orig | alteridx_orig_msg_key              |              | 
 alteridx_orig | alteridx_new_ir_excl               |              | 
 alteridx_orig | alteridx_orig_ir_excl              |              | 
 alteridx_orig | alteridx_new_partition_key_key     |              | 
 alteridx_orig | alteridx_orig_partition_key_key    |              | 
 alteridx_orig | alteridx_new_partition_key_id_key  |              | 
 alteridx_orig | alteridx_orig_partition_key_id_key |              | 
(27 rows)

DROP INDEX alteridx_new_expr_excl_wrong;
ALTER TABLE alteridx_does_not_exist ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_new_expr_excl_wrong; -- failure here
ERROR:  relation "alteridx_does_not_exist" does not exist
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_expr_excl
USING INDEX alteridx_new_expr_excl_wrong; -- failure here
ERROR:  constraint "alteridx_orig_expr_excl" of relation "alteridx_orig" does not exist
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_expr_excl
USING INDEX alteridx_new_expr_excl_wrong; -- failure here
ERROR:  index "alteridx_new_expr_excl_wrong" for table "alteridx_orig" does not exist
--
DROP INDEX alteridx_new_expr_excl_pred;
DROP INDEX alteridx_orig_expr_excl;
DROP INDEX alteridx_new_expr_excl_hash;
DROP INDEX alteridx_new_expr_excl; -- failure here
ERROR:  cannot drop index alteridx_new_expr_excl because constraint alteridx_new_expr_excl on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_new_expr_excl on table alteridx_orig instead.
SELECT * FROM show_index_exprs_pred('alteridx_orig');
    relname    |              indname               |   indpred    | indexprs  
---------------+------------------------------------+--------------+-----------
 alteridx_orig | alteridx_orig_expr_excl1           | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl             | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl1            | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred2       | id > (3 - 1) | id + uniq
 alteridx_orig | alteridx_id_key                    |              | 
 alteridx_orig | alteridx_id_key_deferrable         |              | 
 alteridx_orig | alteridx_new_pkey                  |              | 
 alteridx_orig | alteridx_orig_pkey                 |              | 
 alteridx_orig | alteridx_new_uniq_key_back         |              | 
 alteridx_orig | alteridx_new_uniq_key_no_unique    |              | 
 alteridx_orig | alteridx_new_uniq_key_opt          |              | 
 alteridx_orig | alteridx_new_uniq_key_incl2        |              | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     |              | 
 alteridx_orig | alteridx_new_uniq_key_incl         |              | 
 alteridx_orig | alteridx_new_msg_key_coll          |              | 
 alteridx_orig | alteridx_new_msg_key_ops           |              | 
 alteridx_orig | alteridx_orig_msg_key              |              | 
 alteridx_orig | alteridx_new_ir_excl               |              | 
 alteridx_orig | alteridx_orig_ir_excl              |              | 
 alteridx_orig | alteridx_new_partition_key_key     |              | 
 alteridx_orig | alteridx_orig_partition_key_key    |              | 
 alteridx_orig | alteridx_new_partition_key_id_key  |              | 
 alteridx_orig | alteridx_orig_partition_key_id_key |              | 
(23 rows)

ALTER TABLE another_alteridx ALTER CONSTRAINT another_alteridx_expr_excl
USING INDEX another_alteridx_new_expr_excl;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "another_alteridx_expr_excl" to "another_alteridx_new_expr_excl"
--
--
-- Checking that after simplifying the constants from index expressions some
-- indexes are considered equal.
--
--
SELECT * FROM show_some_index_exprs_pred(
	'another_alteridx',
	'{"another_alteridx_new_expr_excl",
	  "another_alteridx_new_expr_excl_different",
	  "another_alteridx_new_expr_excl_different2"}'::name[]);
     relname      |                  indname                  | indpred |   indexprs   
------------------+-------------------------------------------+---------+--------------
 another_alteridx | another_alteridx_new_expr_excl_different  |         | id + 2 + 2
 another_alteridx | another_alteridx_new_expr_excl            |         | id + 4
 another_alteridx | another_alteridx_new_expr_excl_different2 |         | id + (2 + 2)
(3 rows)

ALTER TABLE another_alteridx ALTER CONSTRAINT another_alteridx_new_expr_excl
USING INDEX another_alteridx_new_expr_excl_different; -- failure here
ERROR:  index in constraint "another_alteridx_new_expr_excl" cannot be replaced by "another_alteridx_new_expr_excl_different"
DETAIL:  Indexes must have the same non-column attributes.
ALTER TABLE another_alteridx ALTER CONSTRAINT another_alteridx_new_expr_excl
USING INDEX another_alteridx_new_expr_excl_different2;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "another_alteridx_new_expr_excl" to "another_alteridx_new_expr_excl_different2"
SELECT * FROM show_indexes_from_relation('another_alteridx');
     relname      |                  indname                  | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |                  conname                  
------------------+-------------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-------------------------------------------
 another_alteridx | another_alteridx_expr_excl                | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 another_alteridx | another_alteridx_new_expr_excl            | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 another_alteridx | another_alteridx_new_expr_excl_different  | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 another_alteridx | another_alteridx_new_expr_excl_different2 | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | another_alteridx_new_expr_excl_different2
 another_alteridx | another_alteridx_pkey                     | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_pkey
 another_alteridx | another_alteridx_uniq_key                 | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_uniq_key
 another_alteridx | another_alteridx_ir_excl                  | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | another_alteridx_ir_excl
(7 rows)

SELECT * FROM show_constraints_named_like('another_%');
                  conname                  | contype | conkey | condeferrable 
-------------------------------------------+---------+--------+---------------
 another_alteridx_new_expr_excl_different2 | x       | {0}    | f
 another_alteridx_pkey                     | p       | {1}    | f
 another_alteridx_uniq_key                 | u       | {2}    | f
 another_alteridx_ir_excl                  | x       | {5}    | f
(4 rows)

--
--
-- Checking that DDL changes can be rolled back
--
--
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_pkey
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(23 rows)

BEGIN;
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_pkey
USING INDEX alteridx_orig_pkey;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_new_pkey" to "alteridx_orig_pkey"
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_pkey
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(23 rows)

ROLLBACK;
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_pkey
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_key     | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | t                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | t                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | t                | f                         | t                     | alteridx_orig_partition_key_id_key
(23 rows)

--
--
-- Checking constraints in partitions and partitioned tables
--
--
SELECT * FROM show_alteridx_index_dependencies();
              indname               |               referenced_indname               
------------------------------------+------------------------------------------------
 alteridx_new_partition_key_id_key  | partitioned_new_alteridx_partition_key_id_key
 alteridx_new_partition_key_key     | partitioned_new_alteridx_partition_key_key
 alteridx_orig_partition_key_id_key | partitioned_orig_alteridx_partition_key_id_key
 alteridx_orig_partition_key_key    | partitioned_orig_alteridx_partition_key_key
(4 rows)

SELECT * FROM show_alteridx_constraint_dependencies();
              conname               |               referenced_conname               
------------------------------------+------------------------------------------------
 alteridx_orig_partition_key_id_key | partitioned_orig_alteridx_partition_key_id_key
 alteridx_orig_partition_key_key    | partitioned_orig_alteridx_partition_key_key
(2 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_partition_key_key
USING INDEX alteridx_new_partition_key_key; -- failure here
ERROR:  index in constraint "alteridx_orig_partition_key_key" cannot be replaced by "alteridx_new_partition_key_key"
DETAIL:  One of the indexes is a partition index.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_partition_key_id_key
USING INDEX alteridx_new_partition_key_id_key; -- failure here
ERROR:  index in constraint "alteridx_orig_partition_key_id_key" cannot be replaced by "alteridx_new_partition_key_id_key"
DETAIL:  One of the indexes is a partition index.
ALTER TABLE partitioned_orig_alteridx
ALTER CONSTRAINT partitioned_orig_alteridx_partition_key_key
USING INDEX partitioned_new_alteridx_partition_key_key; -- failure here
ERROR:  index in constraint "partitioned_orig_alteridx_partition_key_key" cannot be replaced by "partitioned_new_alteridx_partition_key_key"
DETAIL:  One of the indexes is a partitioned index.
ALTER TABLE partitioned_orig_alteridx
ALTER CONSTRAINT partitioned_orig_alteridx_partition_key_id_key
USING INDEX partitioned_new_alteridx_partition_key_id_key; -- failure here
ERROR:  index in constraint "partitioned_orig_alteridx_partition_key_id_key" cannot be replaced by "partitioned_new_alteridx_partition_key_id_key"
DETAIL:  One of the indexes is a partitioned index.
ALTER TABLE partitioned_orig_alteridx DETACH PARTITION alteridx_orig;
SELECT * FROM show_alteridx_index_dependencies();
 indname | referenced_indname 
---------+--------------------
(0 rows)

SELECT * FROM show_alteridx_constraint_dependencies();
 conname | referenced_conname 
---------+--------------------
(0 rows)

SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname               
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+------------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_pkey
 alteridx_orig | alteridx_orig_pkey                 | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_no_unique    | i             | f                    | f           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_opt          | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 1         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl         | i             | f                    | t           | f            | f              | 2 5    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_coll          | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 12341        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_msg_key_ops           | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_orig_ir_excl              | i             | f                    | f           | f            | f              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_key     | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_key    | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_orig_partition_key_key
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_orig_partition_key_id_key
(23 rows)

ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_partition_key_key
USING INDEX alteridx_new_partition_key_key;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_partition_key_key" to "alteridx_new_partition_key_key"
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_orig_partition_key_id_key
USING INDEX alteridx_new_partition_key_id_key;
NOTICE:  ALTER TABLE / ALTER CONSTRAINT USING INDEX will rename constraint "alteridx_orig_partition_key_id_key" to "alteridx_new_partition_key_id_key"
ALTER TABLE partitioned_orig_alteridx
ALTER CONSTRAINT partitioned_orig_alteridx_partition_key_key
USING INDEX partitioned_new_alteridx_partition_key_key; -- failure here
ERROR:  index in constraint "partitioned_orig_alteridx_partition_key_key" cannot be replaced by "partitioned_new_alteridx_partition_key_key"
DETAIL:  One of the indexes is a partitioned index.
ALTER TABLE partitioned_orig_alteridx
ALTER CONSTRAINT partitioned_orig_alteridx_partition_key_id_key
USING INDEX partitioned_new_alteridx_partition_key_id_key; -- failure here
ERROR:  index in constraint "partitioned_orig_alteridx_partition_key_id_key" cannot be replaced by "partitioned_new_alteridx_partition_key_id_key"
DETAIL:  One of the indexes is a partitioned index.
--
--
-- Dropping replaced indexes
--
--
DROP INDEX alteridx_orig_ir_excl;
DROP INDEX alteridx_orig_pkey;
DROP INDEX alteridx_new_uniq_key_no_unique;
DROP INDEX alteridx_new_uniq_key_incl;
DROP INDEX alteridx_new_msg_key_coll;
DROP INDEX alteridx_new_msg_key_ops;
--
-- Trying to drop indexes used in constraints after replacement
--
DROP INDEX alteridx_new_pkey; -- failure here
ERROR:  cannot drop index alteridx_new_pkey because constraint alteridx_new_pkey on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_new_pkey on table alteridx_orig instead.
DROP INDEX alteridx_new_uniq_key_back; -- failure here
ERROR:  cannot drop index alteridx_new_uniq_key_back because constraint alteridx_new_uniq_key_back on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_new_uniq_key_back on table alteridx_orig instead.
DROP INDEX alteridx_orig_msg_key; -- failure here
ERROR:  cannot drop index alteridx_orig_msg_key because constraint alteridx_orig_msg_key on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_orig_msg_key on table alteridx_orig instead.
DROP INDEX alteridx_new_ir_excl; -- failure here
ERROR:  cannot drop index alteridx_new_ir_excl because constraint alteridx_new_ir_excl on table alteridx_orig requires it
HINT:  You can drop constraint alteridx_new_ir_excl on table alteridx_orig instead.
DROP INDEX alteridx_new_uniq_key_opt;
--
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname              
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-----------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_pkey
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_partition_key_key
 alteridx_orig | alteridx_orig_partition_key_key    | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_partition_key_id_key
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
(16 rows)

SELECT * FROM show_constraints_named_like('alteridx_%');
              conname              | contype | conkey | condeferrable 
-----------------------------------+---------+--------+---------------
 alteridx_new_expr_excl            | x       | {0}    | f
 alteridx_new_expr_excl1           | x       | {0}    | f
 alteridx_id_key                   | u       | {1}    | t
 alteridx_new_pkey                 | p       | {1}    | f
 alteridx_new_uniq_key_back        | u       | {2}    | f
 alteridx_orig_parity_check        | c       | {3}    | f
 alteridx_orig_msg_key             | u       | {4}    | f
 alteridx_new_ir_excl              | x       | {5}    | f
 alteridx_new_partition_key_key    | u       | {6}    | f
 alteridx_new_partition_key_id_key | u       | {6,1}  | f
(10 rows)

--
--
-- Checking that indexes unavailable for use can't be picked for replacement
--
--
CREATE UNIQUE INDEX alteridx_new_uniq_key_not_live ON alteridx_orig(uniq);
CREATE UNIQUE INDEX alteridx_new_uniq_key_not_valid ON alteridx_orig(uniq);
CREATE UNIQUE INDEX alteridx_new_uniq_key_not_ready ON alteridx_orig(uniq);
UPDATE pg_index SET indislive=false
FROM pg_class i WHERE indexrelid = i.oid AND i.relname = 'alteridx_new_uniq_key_not_live';
UPDATE pg_index SET indisvalid=false
FROM pg_class i WHERE indexrelid = i.oid AND i.relname = 'alteridx_new_uniq_key_not_valid';
UPDATE pg_index SET indisready=false
FROM pg_class i WHERE indexrelid = i.oid AND i.relname = 'alteridx_new_uniq_key_not_ready';
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname              
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-----------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_pkey
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_not_live     | i             | f                    | t           | f            | f              | 2      | f         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_not_ready    | i             | f                    | t           | f            | f              | 2      | t         | t          | f          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_not_valid    | i             | f                    | t           | f            | f              | 2      | t         | f          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_partition_key_key
 alteridx_orig | alteridx_orig_partition_key_key    | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_partition_key_id_key
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
(19 rows)

--
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_not_live; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_not_live"
DETAIL:  One of the indexes is being dropped.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_not_valid; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_not_valid"
DETAIL:  One of the indexes is not valid for queries.
ALTER TABLE alteridx_orig ALTER CONSTRAINT alteridx_new_uniq_key_back
USING INDEX alteridx_new_uniq_key_not_ready; -- failure here
ERROR:  index in constraint "alteridx_new_uniq_key_back" cannot be replaced by "alteridx_new_uniq_key_not_ready"
DETAIL:  One of the indexes is not ready for inserts.
--
DROP INDEX alteridx_new_uniq_key_not_live;
DROP INDEX alteridx_new_uniq_key_not_valid;
DROP INDEX alteridx_new_uniq_key_not_ready;
--
SELECT * FROM show_indexes_from_relation('alteridx_orig');
    relname    |              indname               | index_relkind | index_relispartition | indisunique | indisprimary | indisexclusion | indkey | indislive | indisvalid | indisready | indoption | indcollation | indimmediate | indisreplident | depends_on_table | depends_on_simple_columns | depends_on_constraint |              conname              
---------------+------------------------------------+---------------+----------------------+-------------+--------------+----------------+--------+-----------+------------+------------+-----------+--------------+--------------+----------------+------------------+---------------------------+-----------------------+-----------------------------------
 alteridx_orig | alteridx_new_expr_excl             | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl
 alteridx_orig | alteridx_new_expr_excl1            | i             | f                    | f           | f            | t              | 0      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | t                     | alteridx_new_expr_excl1
 alteridx_orig | alteridx_new_expr_excl_pred2       | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_orig_expr_excl1           | i             | f                    | f           | f            | f              | 0      | t         | t          | t          | 0         | 0            | t            | f              | t                | t                         | f                     | 
 alteridx_orig | alteridx_id_key                    | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | f            | f              | f                | f                         | t                     | alteridx_id_key
 alteridx_orig | alteridx_id_key_deferrable         | i             | f                    | t           | f            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_pkey                  | i             | f                    | t           | t            | f              | 1      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_pkey
 alteridx_orig | alteridx_new_uniq_key_back         | i             | f                    | t           | f            | f              | 2      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_uniq_key_back
 alteridx_orig | alteridx_new_uniq_key_incl2        | i             | f                    | t           | f            | f              | 2 3    | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     | i             | f                    | t           | f            | f              | 2 4    | t         | t          | t          | 0 0       | 0 100        | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_orig_msg_key              | i             | f                    | t           | f            | f              | 4      | t         | t          | t          | 0         | 100          | t            | f              | f                | f                         | t                     | alteridx_orig_msg_key
 alteridx_orig | alteridx_new_ir_excl               | i             | f                    | f           | f            | t              | 5      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_ir_excl
 alteridx_orig | alteridx_new_partition_key_key     | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | f                         | t                     | alteridx_new_partition_key_key
 alteridx_orig | alteridx_orig_partition_key_key    | i             | f                    | t           | f            | f              | 6      | t         | t          | t          | 0         | 0            | t            | f              | f                | t                         | f                     | 
 alteridx_orig | alteridx_new_partition_key_id_key  | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | f                         | t                     | alteridx_new_partition_key_id_key
 alteridx_orig | alteridx_orig_partition_key_id_key | i             | f                    | t           | f            | f              | 6 1    | t         | t          | t          | 0 0       | 0 0          | t            | f              | f                | t                         | f                     | 
(16 rows)

SELECT * FROM show_index_exprs_pred('alteridx_orig');
    relname    |              indname               |   indpred    | indexprs  
---------------+------------------------------------+--------------+-----------
 alteridx_orig | alteridx_orig_expr_excl1           | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl             | id > 2       | id + uniq
 alteridx_orig | alteridx_new_expr_excl1            | parity < 4   | id + uniq
 alteridx_orig | alteridx_new_expr_excl_pred2       | id > (3 - 1) | id + uniq
 alteridx_orig | alteridx_id_key                    |              | 
 alteridx_orig | alteridx_id_key_deferrable         |              | 
 alteridx_orig | alteridx_new_pkey                  |              | 
 alteridx_orig | alteridx_new_uniq_key_back         |              | 
 alteridx_orig | alteridx_new_uniq_key_incl2        |              | 
 alteridx_orig | alteridx_new_uniq_key_with_msg     |              | 
 alteridx_orig | alteridx_orig_msg_key              |              | 
 alteridx_orig | alteridx_new_ir_excl               |              | 
 alteridx_orig | alteridx_new_partition_key_key     |              | 
 alteridx_orig | alteridx_orig_partition_key_key    |              | 
 alteridx_orig | alteridx_new_partition_key_id_key  |              | 
 alteridx_orig | alteridx_orig_partition_key_id_key |              | 
(16 rows)

SELECT * FROM show_constraints_named_like('alteridx_%');
              conname              | contype | conkey | condeferrable 
-----------------------------------+---------+--------+---------------
 alteridx_new_expr_excl            | x       | {0}    | f
 alteridx_new_expr_excl1           | x       | {0}    | f
 alteridx_id_key                   | u       | {1}    | t
 alteridx_new_pkey                 | p       | {1}    | f
 alteridx_new_uniq_key_back        | u       | {2}    | f
 alteridx_orig_parity_check        | c       | {3}    | f
 alteridx_orig_msg_key             | u       | {4}    | f
 alteridx_new_ir_excl              | x       | {5}    | f
 alteridx_new_partition_key_key    | u       | {6}    | f
 alteridx_new_partition_key_id_key | u       | {6,1}  | f
(10 rows)

--
--
-- Checking that constraints still work
--
--
INSERT INTO alteridx_orig VALUES(1, 0, 1, 'AA', int4range(102, 103), 17); -- failure here
ERROR:  duplicate key value violates unique constraint "alteridx_orig_msg_key"
DETAIL:  Key (msg)=(AA) already exists.
INSERT INTO alteridx_orig VALUES(0, 1, 1, 'AA', int4range(104, 105), 17); -- failure here
ERROR:  duplicate key value violates unique constraint "alteridx_orig_msg_key"
DETAIL:  Key (msg)=(AA) already exists.
INSERT INTO alteridx_orig VALUES(0, 0, 1, 'AA', int4range(100, 107), 17); -- failure here
ERROR:  duplicate key value violates unique constraint "alteridx_orig_msg_key"
DETAIL:  Key (msg)=(AA) already exists.
INSERT INTO alteridx_orig VALUES(0, 0, 1, 'AA', int4range(102, 107), 17); -- failure here
ERROR:  duplicate key value violates unique constraint "alteridx_orig_msg_key"
DETAIL:  Key (msg)=(AA) already exists.
INSERT INTO alteridx_orig VALUES(NULL, 0, 1, 'AA', int4range(102, 107), 17); -- failure here
ERROR:  null value in column "id" of relation "alteridx_orig" violates not-null constraint
DETAIL:  Failing row contains (null, 0, 1, AA, [102,107), 17).
INSERT INTO alteridx_orig VALUES(0, NULL, 1, 'AA', int4range(102, 107), 17); -- failure here
ERROR:  null value in column "uniq" of relation "alteridx_orig" violates not-null constraint
DETAIL:  Failing row contains (0, null, 1, AA, [102,107), 17).
INSERT INTO alteridx_orig VALUES(-1, -1, 1, 'BB', int4range(108, 110), 17);
--
SELECT * FROM alteridx_orig;
 id | uniq | parity | msg |    ir     | partition_key 
----+------+--------+-----+-----------+---------------
  1 |    1 |      1 | ?@  | [2,3)     |             1
  2 |    2 |      0 | @A  | [4,5)     |             2
  3 |    3 |      1 | AB  | [6,7)     |             3
  4 |    4 |      0 | BC  | [8,9)     |             4
  5 |    5 |      1 | CD  | [10,11)   |             5
  6 |    6 |      0 | DE  | [12,13)   |             6
  7 |    7 |      1 | EF  | [14,15)   |             7
  8 |    8 |      0 | FG  | [16,17)   |             8
  9 |    9 |      1 | GH  | [18,19)   |             9
 10 |   10 |      0 | HI  | [20,21)   |            10
  0 |    0 |      1 | AA  | [102,107) |            15
 -1 |   -1 |      1 | BB  | [108,110) |            17
(12 rows)

--
--
DROP FUNCTION show_indexes_from_relation(searched_relname name);
DROP FUNCTION show_constraints_named_like(searched_conname name);
DROP FUNCTION show_index_exprs_pred(searched_relname name);
DROP TABLE alteridx_orig;
DROP TABLE partitioned_orig_alteridx;
DROP TABLE another_alteridx;
DROP TABLE third_alteridx;
