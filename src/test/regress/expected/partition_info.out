--
-- Tests for pg_partition_children
--
create table ptif_test (a int, b int) partition by range (a);
create table ptif_test0 partition of ptif_test for values from (minvalue) to (0) partition by list (b);
create table ptif_test01 partition of ptif_test0 for values in (1);
create table ptif_test1 partition of ptif_test for values from (0) to (100) partition by list (b);
create table ptif_test11 partition of ptif_test1 for values in (1);
create table ptif_test2 partition of ptif_test for values from (100) to (maxvalue);
insert into ptif_test select i, 1 from generate_series(-500, 500) i;
-- all tables in the tree
select *, pg_relation_size(relid) as size from pg_partition_children('ptif_test');
    relid    |  parentid  | level | isleaf | size  
-------------+------------+-------+--------+-------
 ptif_test   |            |     0 | f      |     0
 ptif_test0  | ptif_test  |     1 | f      |     0
 ptif_test1  | ptif_test  |     1 | f      |     0
 ptif_test2  | ptif_test  |     1 | t      | 16384
 ptif_test01 | ptif_test0 |     2 | t      | 24576
 ptif_test11 | ptif_test1 |     2 | t      |  8192
(6 rows)

-- all table excluding the root
select *, pg_relation_size(relid) as size from pg_partition_children('ptif_test') where level > 0;
    relid    |  parentid  | level | isleaf | size  
-------------+------------+-------+--------+-------
 ptif_test0  | ptif_test  |     1 | f      |     0
 ptif_test1  | ptif_test  |     1 | f      |     0
 ptif_test2  | ptif_test  |     1 | t      | 16384
 ptif_test01 | ptif_test0 |     2 | t      | 24576
 ptif_test11 | ptif_test1 |     2 | t      |  8192
(5 rows)

-- all leaf partitions
select * from pg_partition_children('ptif_test') where isleaf;
    relid    |  parentid  | level | isleaf 
-------------+------------+-------+--------
 ptif_test2  | ptif_test  |     1 | t
 ptif_test01 | ptif_test0 |     2 | t
 ptif_test11 | ptif_test1 |     2 | t
(3 rows)

-- total size of all partitions
select sum(pg_relation_size(relid)) as total_size from pg_partition_children('ptif_test');
 total_size 
------------
      49152
(1 row)

-- total size of first level partitions
select sum(pg_relation_size(relid)) as total_size from pg_partition_children('ptif_test') where level = 1;
 total_size 
------------
      16384
(1 row)

-- check that passing a lower-level table to pg_partition_children works
select *, pg_relation_size(relid) as size from pg_partition_children('ptif_test0');
    relid    |  parentid  | level | isleaf | size  
-------------+------------+-------+--------+-------
 ptif_test0  | ptif_test  |     0 | f      |     0
 ptif_test01 | ptif_test0 |     1 | t      | 24576
(2 rows)

select *, pg_relation_size(relid) as size from pg_partition_children('ptif_test01');
    relid    |  parentid  | level | isleaf | size  
-------------+------------+-------+--------+-------
 ptif_test01 | ptif_test0 |     0 | t      | 24576
(1 row)

select sum(pg_relation_size(relid)) as total_size from pg_partition_children('ptif_test01');
 total_size 
------------
      24576
(1 row)

-- this one should result in null, as there are no level 1 partitions of a leaf partition
select sum(pg_relation_size(relid)) as total_size from pg_partition_children('ptif_test01') where level = 1;
 total_size 
------------
           
(1 row)

drop table ptif_test;
